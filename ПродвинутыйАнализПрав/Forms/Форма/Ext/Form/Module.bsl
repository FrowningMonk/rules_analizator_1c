///////////////////////////////////////////////////////////////////////////////////////////////////////
// Модуль формы внешней обработки "Экспорт анализа прав доступа в Markdown"
///////////////////////////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	// Установка начальных значений
	ПоказыватьПрофили = Истина;

	// Инициализация списка типов доступа для выбора
	Элементы.ТипДоступа.СписокВыбора.Добавить("", "<Все>");
	Элементы.ТипДоступа.СписокВыбора.Добавить("Чтение", "Чтение");
	Элементы.ТипДоступа.СписокВыбора.Добавить("Добавление", "Добавление");
	Элементы.ТипДоступа.СписокВыбора.Добавить("Изменение", "Изменение");
	Элементы.ТипДоступа.СписокВыбора.Добавить("Удаление", "Удаление");
	Элементы.ТипДоступа.СписокВыбора.Добавить("Просмотр", "Просмотр");
	Элементы.ТипДоступа.СписокВыбора.Добавить("Редактирование", "Редактирование");
	Элементы.ТипДоступа.СписокВыбора.Добавить("Использование", "Использование");
	Элементы.ТипДоступа.СписокВыбора.Добавить("Проведение", "Проведение");
	Элементы.ТипДоступа.СписокВыбора.Добавить("Администрирование", "Администрирование");

	// Инициализация параметров ранжирования (PageRank)
	EpsilonPageRank = 0.0001;
	МаксИтерацийPageRank = 100;
	ПорогОтсечения = 0;

	// Фильтры типов объектов для ранжирования
	ВключатьСправочники = Истина;
	ВключатьДокументы = Истина;
	ВключатьРегистрыСведений = Истина;
	ВключатьРегистрыНакопления = Истина;
	ВключатьРегистрыБухгалтерии = Ложь;
	ВключатьОтчеты = Ложь;
	ВключатьОбработки = Ложь;
	ВключатьКонстанты = Ложь;

	// Настройки ИИ по умолчанию
	МодельИИ = "gpt-4o-mini";
	СистемныйПромптИИ = "Ты-опытный архитектор 1С. Твоя задача-проанализировать доступы к объектам "
		+ "системы 1С. На основании этих доступов дай краткое описание какие возможности дают эти "
		+ "права в системе. 1-2 предложение.";

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

// Обработчик команды "Ранжировать объекты"
// Выполняет ранжирование объектов по бизнес-значимости (PageRank)
//
&НаКлиенте
Процедура РанжироватьОбъекты(Команда)

	РанжироватьОбъектыНаСервере();

	Если ТаблицаРанжирования.Количество() = 0 Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Объекты для ранжирования не найдены. Проверьте фильтры типов объектов.'"));
	Иначе
		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Ранжирование завершено'"),
			,
			СтрШаблон(НСтр("ru = 'Проанализировано объектов: %1'"), ТаблицаРанжирования.Количество()),
			БиблиотекаКартинок.Информация);
	КонецЕсли;

КонецПроцедуры

// Обработчик команды "Получить ТЗ"
// Выполняет анализ прав и заполняет таблицу результатов на форме
//
&НаКлиенте
Процедура ПолучитьТЗ(Команда)

	// Проверка заполненности хотя бы одного параметра
	Если Не ЗначениеЗаполнено(ОбъектМетаданных)
		И Не ЗначениеЗаполнено(ИмяРоли)
		И Не ЗначениеЗаполнено(Профиль) Тогда

		ПоказатьПредупреждение(, НСтр("ru = 'Необходимо заполнить хотя бы один из параметров:
			|Объект метаданных, Имя роли или Профиль.'"));
		Возврат;

	КонецЕсли;

	ПолучитьТЗНаСервере();

	Если ТаблицаРезультатов.Количество() = 0 Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'По заданным параметрам данные не найдены.'"));
	КонецЕсли;

КонецПроцедуры

// Обработчик команды "Выгрузить в Markdown"
// Сохраняет результаты анализа в файл .md через диалог выбора файла
//
&НаКлиенте
Процедура ВыгрузитьВMarkdown(Команда)

	// Проверка наличия данных
	Если ТаблицаРезультатов.Количество() = 0 Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Таблица результатов пуста. Сначала выполните анализ.'"));
		Возврат;
	КонецЕсли;

	// Формирование имени файла по умолчанию
	ИмяФайлаПоУмолчанию = "АнализПрав_" + Формат(ТекущаяДата(), "ДФ=yyyyMMdd_HHmmss") + ".md";

	// Настройка диалога сохранения файла
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
	Диалог.Заголовок = НСтр("ru = 'Сохранить файл анализа прав'");
	Диалог.Фильтр = НСтр("ru = 'Файлы Markdown (*.md)|*.md|Все файлы (*.*)|*.*'");
	Диалог.ПолноеИмяФайла = ИмяФайлаПоУмолчанию;
	Диалог.Расширение = "md";

	ОповещениеОЗакрытии = Новый ОписаниеОповещения("ВыгрузитьВMarkdownЗавершение", ЭтотОбъект);
	Диалог.Показать(ОповещениеОЗакрытии);

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункцииНаКлиенте

// Обработчик завершения диалога выбора файла для сохранения
//
&НаКлиенте
Процедура ВыгрузитьВMarkdownЗавершение(ВыбранныеФайлы, ДополнительныеПараметры) Экспорт

	Если ВыбранныеФайлы = Неопределено Или ВыбранныеФайлы.Количество() = 0 Тогда
		Возврат; // Пользователь отменил выбор
	КонецЕсли;

	ПутьКФайлу = ВыбранныеФайлы[0];

	// Получение текста Markdown на сервере
	ТекстMarkdown = ПолучитьТекстMarkdownНаСервере();

	// Сохранение файла
	СохранитьТекстВФайл(ПутьКФайлу, ТекстMarkdown);

КонецПроцедуры

// Сохраняет текст в файл на клиенте
//
&НаКлиенте
Процедура СохранитьТекстВФайл(ПутьКФайлу, ТекстДляЗаписи)

	Попытка
		ЗаписьТекста = Новый ЗаписьТекста(ПутьКФайлу, КодировкаТекста.UTF8);
		ЗаписьТекста.Записать(ТекстДляЗаписи);
		ЗаписьТекста.Закрыть();

		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Экспорт завершён'"),
			,
			НСтр("ru = 'Файл успешно сохранён'"),
			БиблиотекаКартинок.Информация);

	Исключение
		ПоказатьПредупреждение(, НСтр("ru = 'Ошибка при сохранении файла:'") + Символы.ПС + ОписаниеОшибки());
	КонецПопытки;

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункцииНаСервере

// Выполняет ранжирование объектов по бизнес-значимости (PageRank)
//
&НаСервере
Процедура РанжироватьОбъектыНаСервере()

	// Формирование параметров ранжирования
	ПараметрыРанжирования = Новый Структура;

	ПараметрыРанжирования.Вставить("Epsilon", EpsilonPageRank);
	ПараметрыРанжирования.Вставить("МаксИтераций", МаксИтерацийPageRank);
	ПараметрыРанжирования.Вставить("ПорогОтсечения", ПорогОтсечения);

	ПараметрыРанжирования.Вставить("ВключатьСправочники", ВключатьСправочники);
	ПараметрыРанжирования.Вставить("ВключатьДокументы", ВключатьДокументы);
	ПараметрыРанжирования.Вставить("ВключатьРегистрыСведений", ВключатьРегистрыСведений);
	ПараметрыРанжирования.Вставить("ВключатьРегистрыНакопления", ВключатьРегистрыНакопления);
	ПараметрыРанжирования.Вставить("ВключатьРегистрыБухгалтерии", ВключатьРегистрыБухгалтерии);
	ПараметрыРанжирования.Вставить("ВключатьОтчеты", ВключатьОтчеты);
	ПараметрыРанжирования.Вставить("ВключатьОбработки", ВключатьОбработки);
	ПараметрыРанжирования.Вставить("ВключатьКонстанты", ВключатьКонстанты);

	// Вызов функции ранжирования из модуля объекта
	РезультатРанжирования = ПолучитьОбъект().РанжироватьОбъектыПоЗначимости(ПараметрыРанжирования);

	// Очистка и заполнение таблицы на форме
	ТаблицаРанжирования.Очистить();

	Для Каждого СтрокаРезультата Из РезультатРанжирования Цикл
		НоваяСтрока = ТаблицаРанжирования.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаРезультата);
	КонецЦикла;

	КоличествоОбъектовРанжирования = ТаблицаРанжирования.Количество();

КонецПроцедуры

// Выполняет анализ прав и заполняет таблицу результатов
//
&НаСервере
Процедура ПолучитьТЗНаСервере()

	// Формирование параметров
	ПараметрыАнализа = Новый Структура;

	Если ЗначениеЗаполнено(ОбъектМетаданных) Тогда
		ПараметрыАнализа.Вставить("ОбъектМетаданных", ОбъектМетаданных);
	КонецЕсли;

	Если ЗначениеЗаполнено(ИмяРоли) Тогда
		ПараметрыАнализа.Вставить("ИмяРоли", ИмяРоли);
	КонецЕсли;

	Если ЗначениеЗаполнено(Профиль) Тогда
		ПараметрыАнализа.Вставить("Профиль", Профиль);
	КонецЕсли;

	Если ЗначениеЗаполнено(ТипДоступа) Тогда
		ПараметрыАнализа.Вставить("ТипДоступа", ТипДоступа);
	КонецЕсли;

	ПараметрыАнализа.Вставить("ПоказыватьПрофили", ПоказыватьПрофили);

	// Формирование фильтра по типам объектов метаданных
	ФильтрОбъектов = Новый Структура;
	ФильтрОбъектов.Вставить("ВключатьСправочники", ВключатьСправочники);
	ФильтрОбъектов.Вставить("ВключатьДокументы", ВключатьДокументы);
	ФильтрОбъектов.Вставить("ВключатьРегистрыСведений", ВключатьРегистрыСведений);
	ФильтрОбъектов.Вставить("ВключатьРегистрыНакопления", ВключатьРегистрыНакопления);
	ФильтрОбъектов.Вставить("ВключатьРегистрыБухгалтерии", ВключатьРегистрыБухгалтерии);
	ФильтрОбъектов.Вставить("ВключатьОтчеты", ВключатьОтчеты);
	ФильтрОбъектов.Вставить("ВключатьОбработки", ВключатьОбработки);
	ФильтрОбъектов.Вставить("ВключатьКонстанты", ВключатьКонстанты);
	ПараметрыАнализа.Вставить("ФильтрОбъектов", ФильтрОбъектов);

	// Вызов функции анализа из модуля объекта
	РезультатАнализа = ПолучитьОбъект().ПолучитьИтоговуюТаблицу(ПараметрыАнализа);

	// Очистка и заполнение таблицы на форме
	ТаблицаРезультатов.Очистить();

	Для Каждого СтрокаРезультата Из РезультатАнализа Цикл
		НоваяСтрока = ТаблицаРезультатов.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаРезультата);
	КонецЦикла;

	КоличествоСтрокРезультата = ТаблицаРезультатов.Количество();

КонецПроцедуры

// Возвращает ссылку на объект обработки
//
&НаСервере
Функция ПолучитьОбъект()

	Возврат РеквизитФормыВЗначение("Объект");

КонецФункции

// Формирует текст в формате Markdown из таблицы результатов
//
// Возвращаемое значение:
//   Строка - текст в формате Markdown
//
&НаСервере
Функция ПолучитьТекстMarkdownНаСервере()

	СтрокиМД = Новый Массив;

	Если ТаблицаРезультатов.Количество() > 0 Тогда

		// Профиль - один раз над таблицей
		СтрокиМД.Добавить("Профиль: " + Строка(Профиль));

		// Заголовок таблицы
		СтрокиМД.Добавить("| Объект метаданных | Имя роли | Тип доступа | RLS |");

		// Строки таблицы
		Для Каждого СтрокаТЗ Из ТаблицаРезультатов Цикл

			ОбъектМД = ЭкранироватьДляMarkdown(СтрокаТЗ.ОбъектМетаданных);
			ТипДоступаЗнач = ЭкранироватьДляMarkdown(СтрокаТЗ.ТипДоступа);
			RLS = ?(СтрокаТЗ.ЕстьОграничение, "Да", "Нет");

			СтрокаТаблицы = "| " + ОбъектМД + " | " + СтрокаТЗ.ИмяРоли + " | " + ТипДоступаЗнач + " | " + RLS + " |";

			СтрокиМД.Добавить(СтрокаТаблицы);
		КонецЦикла;

	КонецЕсли;

	Возврат СтрСоединить(СтрокиМД, Символы.ПС);

КонецФункции

// Экранирует специальные символы Markdown в строке
//
// Параметры:
//   Текст - Строка - исходный текст
//
// Возвращаемое значение:
//   Строка - экранированный текст
//
&НаСервере
Функция ЭкранироватьДляMarkdown(Текст)

	Если Не ЗначениеЗаполнено(Текст) Тогда
		Возврат "";
	КонецЕсли;

	Результат = Строка(Текст);

	// Замена символа pipe на экранированный
	Результат = СтрЗаменить(Результат, "|", "\|");

	// Замена переносов строк на пробелы
	Результат = СтрЗаменить(Результат, Символы.ПС, " ");
	Результат = СтрЗаменить(Результат, Символы.ВК, " ");

	Возврат Результат;

КонецФункции

&НаСервере
Процедура АналитикаПравНаСервере(ТекстПрав)

	Если Не ЗначениеЗаполнено(МодельИИ) Тогда
		ОбщегоНазначения.СообщитьПользователю(
			"Не указано название модели ИИ. Перейдите на вкладку 'Настройки для отладки'.");
		Возврат;
	КонецЕсли;

	// Поиск модели по названию в справочнике
	Модель = Справочники.КИИ_МоделиИИ.НайтиПоНаименованию(МодельИИ);
	Если Не ЗначениеЗаполнено(Модель) Тогда
		ОбщегоНазначения.СообщитьПользователю(
			"Модель ИИ '" + МодельИИ + "' не найдена в справочнике.");
		Возврат;
	КонецЕсли;

	Промпт = Новый Структура;
	Промпт.Вставить("СистемныйПромпт", СистемныйПромптИИ);
	Промпт.Вставить("ПользовательскийПромпт", ТекстПрав);

	Ответ = КИИ_КоннекторИИ.ЗапросКМодели(Модель, Промпт);

	Если Не Ответ.ЭтоОшибка Тогда
		ОбщегоНазначения.СообщитьПользователю("Анализ: " + Ответ.ТекстОтвета);
		ОбщегоНазначения.СообщитьПользователю("Использовано токенов: " + Ответ.ВсегоТокенов);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура АналитикаПрав(Команда)
	ТекстПрав = ПолучитьТекстMarkdownНаСервере();
	АналитикаПравНаСервере(ТекстПрав);
КонецПроцедуры

#КонецОбласти
