///////////////////////////////////////////////////////////////////////////////////////////////////////
// Внешняя обработка "Экспорт анализа прав доступа в Markdown"
// Анализирует права доступа ролей и профилей к объектам метаданных конфигурации
// и выгружает результаты в формате Markdown
///////////////////////////////////////////////////////////////////////////////////////////////////////

#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Возвращает сведения о внешней обработке для регистрации в системе БСП.
//
// Возвращаемое значение:
//   Структура - параметры регистрации внешней обработки
//
Функция СведенияОВнешнейОбработке() Экспорт
	
	ПараметрыРегистрации = ДополнительныеОтчетыИОбработки.СведенияОВнешнейОбработке(СтандартныеПодсистемыСервер.ВерсияБиблиотеки());	
	
	ПараметрыРегистрации.Вид = ДополнительныеОтчетыИОбработкиКлиентСервер.ВидОбработкиДополнительнаяОбработка();
    ПараметрыРегистрации.Версия = "1.0";
	ПараметрыРегистрации.Наименование = "Продвинутый анализ прав доступа";
	ПараметрыРегистрации.БезопасныйРежим = Ложь;
	ПараметрыРегистрации.Информация = 
		НСтр("ru = 'Обработка анализирует права доступа ролей и профилей к объектам метаданных
		|и выгружает результаты в формат Markdown (.md).
		|Позволяет узнать, какие роли/профили имеют доступ к указанному объекту,
		|или какие объекты доступны указанной роли/профилю.'");
	
	НоваяКоманда = ПараметрыРегистрации.Команды.Добавить();
	НоваяКоманда.Представление = НСтр("ru = 'Экспорт анализа прав доступа'");
	НоваяКоманда.Идентификатор = "ЭкспортАнализаПравДоступа";
	НоваяКоманда.Использование = "ОткрытиеФормы";
	НоваяКоманда.ПоказыватьОповещение = Ложь;

	Возврат ПараметрыРегистрации;

КонецФункции


// Возвращает итоговую таблицу с результатами анализа прав доступа.
//
// Параметры:
//   Параметры - Структура - параметры анализа:
//       * ОбъектМетаданных - Строка - полное имя объекта метаданных или Неопределено
//       * ИмяРоли - Строка - имя роли или Неопределено
//       * Профиль - СправочникСсылка.ПрофилиГруппДоступа - профиль или Неопределено
//       * ТипДоступа - Строка, Массив - фильтр по типу доступа или Неопределено
//       * ПоказыватьПрофили - Булево - показывать профили вместо ролей (по умолчанию Истина)
//
// Возвращаемое значение:
//   ТаблицаЗначений - результаты анализа:
//       * ОбъектМетаданных - Строка - полное имя объекта (при фильтре по роли/профилю)
//       * ИмяРоли - Строка - имя роли (при фильтре по объекту)
//       * Профиль - СправочникСсылка.ПрофилиГруппДоступа - профиль
//       * ТипДоступа - Строка - тип права доступа
//       * ЕстьОграничение - Булево - наличие RLS-ограничения
//
Функция ПолучитьИтоговуюТаблицу(Параметры) Экспорт

	// Инициализация параметров
	ОбъектМетаданных = Неопределено;
	ИмяРоли = Неопределено;
	Профиль = Неопределено;
	ФильтрТипДоступа = Неопределено;
	ПоказыватьПрофили = Истина;
	ФильтрОбъектов = Неопределено;

	Если Параметры.Свойство("ОбъектМетаданных") Тогда
		ОбъектМетаданных = Параметры.ОбъектМетаданных;
	КонецЕсли;

	Если Параметры.Свойство("ИмяРоли") Тогда
		ИмяРоли = Параметры.ИмяРоли;
	КонецЕсли;

	Если Параметры.Свойство("Профиль") Тогда
		Профиль = Параметры.Профиль;
	КонецЕсли;

	Если Параметры.Свойство("ТипДоступа") Тогда
		ФильтрТипДоступа = Параметры.ТипДоступа;
	КонецЕсли;

	Если Параметры.Свойство("ПоказыватьПрофили") Тогда
		ПоказыватьПрофили = Параметры.ПоказыватьПрофили;
	КонецЕсли;

	Если Параметры.Свойство("ФильтрОбъектов") Тогда
		ФильтрОбъектов = Параметры.ФильтрОбъектов;
	КонецЕсли;

	// Валидация комбинации фильтров
	Если ЗначениеЗаполнено(Профиль) И ЗначениеЗаполнено(ИмяРоли) Тогда
		// Проверить, что роль входит в профиль
		РолиПрофиляДляПроверки = ПолучитьРолиПрофиля(Профиль);
		РольНайдена = Ложь;
		Для Каждого ОписаниеРоли Из РолиПрофиляДляПроверки Цикл
			Если ОписаниеРоли.ИмяРоли = ИмяРоли Тогда
				РольНайдена = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		Если Не РольНайдена Тогда
			ВызватьИсключение "Роль """ + ИмяРоли + """ не входит в профиль """ + Строка(Профиль) + """";
		КонецЕсли;
	КонецЕсли;

	// Создание результирующей таблицы
	РезультатАнализа = СоздатьТаблицуРезультатов();

	// Определение режима работы с учётом комбинации фильтров
	Если ЗначениеЗаполнено(ОбъектМетаданных) Тогда
		// Режим: анализ по объекту метаданных (с возможной фильтрацией по Профилю/Роли)
		АнализПоОбъектуМетаданных(РезультатАнализа, ОбъектМетаданных, ПоказыватьПрофили,
			ФильтрТипДоступа, Профиль, ИмяРоли);

	ИначеЕсли ЗначениеЗаполнено(Профиль) Тогда
		// Режим: анализ по профилю (с возможной фильтрацией по Роли)
		АнализПоПрофилю(РезультатАнализа, Профиль, ФильтрТипДоступа, ФильтрОбъектов, ИмяРоли);

	ИначеЕсли ЗначениеЗаполнено(ИмяРоли) Тогда
		// Режим: анализ по роли
		АнализПоРоли(РезультатАнализа, ИмяРоли, ФильтрТипДоступа, ФильтрОбъектов);

	КонецЕсли;

	Возврат СгруппироватьТипыДоступа(РезультатАнализа);

КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область СозданиеТаблиц

// Создаёт пустую таблицу результатов анализа.
//
// Возвращаемое значение:
//   ТаблицаЗначений - пустая таблица с колонками результатов
//
Функция СоздатьТаблицуРезультатов()

	Результат = Новый ТаблицаЗначений;

	Результат.Колонки.Добавить("ОбъектМетаданных", ТипСтрока(430));
	Результат.Колонки.Добавить("ИмяРоли", ТипСтрока(255));
	Результат.Колонки.Добавить("Профиль", Новый ОписаниеТипов("СправочникСсылка.ПрофилиГруппДоступа"));
	Результат.Колонки.Добавить("ТипДоступа", ТипСтрока(100));
	Результат.Колонки.Добавить("ЕстьОграничение", Новый ОписаниеТипов("Булево"));

	Возврат Результат;

КонецФункции

// Группирует строки таблицы результатов, объединяя типы доступа через запятую.
// Группировка выполняется по комбинации (ОбъектМетаданных, ИмяРоли, Профиль, ЕстьОграничение).
//
// Параметры:
//   ИсходнаяТаблица - ТаблицаЗначений - исходная таблица с отдельными строками для каждого типа доступа
//
// Возвращаемое значение:
//   ТаблицаЗначений - сгруппированная таблица с объединёнными типами доступа
//
Функция СгруппироватьТипыДоступа(ИсходнаяТаблица)

	Результат = СоздатьТаблицуРезультатов();

	// Создаём соответствие для группировки
	Группы = Новый Соответствие;

	Для Каждого СтрокаТаблицы Из ИсходнаяТаблица Цикл
		// Ключ группировки
		Ключ = СтрокаТаблицы.ОбъектМетаданных + "|"
			 + СтрокаТаблицы.ИмяРоли + "|"
			 + Строка(СтрокаТаблицы.Профиль) + "|"
			 + Строка(СтрокаТаблицы.ЕстьОграничение);

		Группа = Группы.Получить(Ключ);
		Если Группа = Неопределено Тогда
			Группа = Новый Структура;
			Группа.Вставить("ОбъектМетаданных", СтрокаТаблицы.ОбъектМетаданных);
			Группа.Вставить("ИмяРоли", СтрокаТаблицы.ИмяРоли);
			Группа.Вставить("Профиль", СтрокаТаблицы.Профиль);
			Группа.Вставить("ЕстьОграничение", СтрокаТаблицы.ЕстьОграничение);
			Группа.Вставить("ТипыДоступа", Новый Массив);
			Группы.Вставить(Ключ, Группа);
		КонецЕсли;

		Группа.ТипыДоступа.Добавить(СтрокаТаблицы.ТипДоступа);
	КонецЦикла;

	// Формируем результат
	Для Каждого КлючЗначение Из Группы Цикл
		Группа = КлючЗначение.Значение;
		НоваяСтрока = Результат.Добавить();
		НоваяСтрока.ОбъектМетаданных = Группа.ОбъектМетаданных;
		НоваяСтрока.ИмяРоли = Группа.ИмяРоли;
		НоваяСтрока.Профиль = Группа.Профиль;
		НоваяСтрока.ТипДоступа = СтрСоединить(Группа.ТипыДоступа, ",");
		НоваяСтрока.ЕстьОграничение = Группа.ЕстьОграничение;
	КонецЦикла;

	Возврат Результат;

КонецФункции

#КонецОбласти

#Область ОсновныеПроцедурыАнализа

// Выполняет анализ прав по указанному объекту метаданных.
// Определяет, какие роли и профили имеют доступ к объекту.
//
// Параметры:
//   Результат - ТаблицаЗначений - таблица для заполнения результатами
//   ПолноеИмяОбъекта - Строка - полное имя объекта метаданных
//   ПоказыватьПрофили - Булево - показывать профили вместо ролей
//   ФильтрТипДоступа - Строка, Массив, Неопределено - фильтр по типу доступа
//   ФильтрПрофиль - СправочникСсылка.ПрофилиГруппДоступа, Неопределено - фильтр по профилю
//   ФильтрИмяРоли - Строка, Неопределено - фильтр по имени роли
//
Процедура АнализПоОбъектуМетаданных(Результат, ПолноеИмяОбъекта, ПоказыватьПрофили,
	ФильтрТипДоступа, ФильтрПрофиль = Неопределено, ФильтрИмяРоли = Неопределено)

	// Получение объекта метаданных
	МетаданныеОбъекта = ПолучитьОбъектМетаданных(ПолноеИмяОбъекта);
	Если МетаданныеОбъекта = Неопределено Тогда
		Возврат;
	КонецЕсли;

	ПредставлениеОбъекта = ПолучитьПредставлениеОбъектаМетаданных(МетаданныеОбъекта, ПолноеИмяОбъекта);

	// Получение описания прав для данного типа объекта
	ОписаниеПрав = ПолучитьОписаниеПравОбъекта(ПолноеИмяОбъекта);
	Если ОписаниеПрав = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Получение описания ролей
	ОписаниеРолей = ПолучитьОписаниеРолей();

	// Получение профилей, если требуется
	ПрофилиРолей = Неопределено;
	Если ПоказыватьПрофили Тогда
		ПрофилиРолей = ПолучитьПрофилиРолей();
	КонецЕсли;

	// Обработка фильтра по типу доступа
	МассивФильтра = ПодготовитьФильтрТипаДоступа(ФильтрТипДоступа);

	// Перебор ролей и проверка прав
	Для Каждого СтрокаРоли Из ОписаниеРолей Цикл

		// Фильтрация по имени роли
		Если ЗначениеЗаполнено(ФильтрИмяРоли) И СтрокаРоли.ИмяРоли <> ФильтрИмяРоли Тогда
			Продолжить;
		КонецЕсли;

		// Проверка прав роли на объект
		ПроверитьИДобавитьПраваРоли(Результат, СтрокаРоли, МетаданныеОбъекта,
			ПолноеИмяОбъекта, ПредставлениеОбъекта, ОписаниеПрав,
			ПоказыватьПрофили, ПрофилиРолей, МассивФильтра, ФильтрПрофиль);

	КонецЦикла;

КонецПроцедуры

// Выполняет анализ прав по указанному профилю.
// Определяет, к каким объектам метаданных есть доступ у профиля.
//
// Параметры:
//   Результат - ТаблицаЗначений - таблица для заполнения результатами
//   Профиль - СправочникСсылка.ПрофилиГруппДоступа - профиль
//   ФильтрТипДоступа - Строка, Массив, Неопределено - фильтр по типу доступа
//   ФильтрОбъектов - Структура, Неопределено - фильтр по типам объектов метаданных
//   ФильтрИмяРоли - Строка, Неопределено - фильтр по имени роли (роль должна входить в профиль)
//
Процедура АнализПоПрофилю(Результат, Профиль, ФильтрТипДоступа, ФильтрОбъектов = Неопределено,
	ФильтрИмяРоли = Неопределено)

	// Получение ролей профиля
	РолиПрофиля = ПолучитьРолиПрофиля(Профиль);
	Если РолиПрофиля.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	// Фильтрация по роли если задано
	Если ЗначениеЗаполнено(ФильтрИмяРоли) Тогда
		ОтфильтрованныеРоли = Новый Массив;
		Для Каждого ОписаниеРоли Из РолиПрофиля Цикл
			Если ОписаниеРоли.ИмяРоли = ФильтрИмяРоли Тогда
				ОтфильтрованныеРоли.Добавить(ОписаниеРоли);
				Прервать;
			КонецЕсли;
		КонецЦикла;
		РолиПрофиля = ОтфильтрованныеРоли;
	КонецЕсли;

	ПредставлениеПрофиля = Строка(Профиль);

	// Обработка фильтра по типу доступа
	МассивФильтра = ПодготовитьФильтрТипаДоступа(ФильтрТипДоступа);

	// Перебор объектов метаданных с правами
	КоллекцииОбъектов = ПолучитьКоллекцииОбъектовМетаданных();

	Для Каждого ОписаниеКоллекции Из КоллекцииОбъектов Цикл

		Для Каждого МетаданныеОбъекта Из ОписаниеКоллекции.Коллекция Цикл

			ПолноеИмяОбъекта = МетаданныеОбъекта.ПолноеИмя();
			ПредставлениеОбъекта = МетаданныеОбъекта.Представление();

			// Получение описания прав для объекта
			ОписаниеПрав = ПолучитьОписаниеПравОбъекта(ПолноеИмяОбъекта);
			Если ОписаниеПрав = Неопределено Тогда
				Продолжить;
			КонецЕсли;

			// Проверка прав профиля (объединение прав всех ролей)
			ПроверитьИДобавитьПраваПрофиляНаОбъект(Результат, РолиПрофиля,
				МетаданныеОбъекта, ПолноеИмяОбъекта, ПредставлениеОбъекта,
				ОписаниеПрав, Профиль, ПредставлениеПрофиля, МассивФильтра);

		КонецЦикла;

	КонецЦикла;

КонецПроцедуры

// Выполняет анализ прав по указанной роли.
// Определяет, к каким объектам метаданных есть доступ у роли.
//
// Параметры:
//   Результат - ТаблицаЗначений - таблица для заполнения результатами
//   ИмяРоли - Строка - имя роли
//   ФильтрТипДоступа - Строка, Массив, Неопределено - фильтр по типу доступа
//   ФильтрОбъектов - Структура, Неопределено - фильтр по типам объектов метаданных
//
Процедура АнализПоРоли(Результат, ИмяРоли, ФильтрТипДоступа, ФильтрОбъектов = Неопределено)

	// Проверка существования роли
	МетаданныеРоли = Метаданные.Роли.Найти(ИмяРоли);
	Если МетаданныеРоли = Неопределено Тогда
		Возврат;
	КонецЕсли;

	ПредставлениеРоли = МетаданныеРоли.Представление();

	// Обработка фильтра по типу доступа
	МассивФильтра = ПодготовитьФильтрТипаДоступа(ФильтрТипДоступа);

	// Перебор объектов метаданных с правами
	КоллекцииОбъектов = ПолучитьКоллекцииОбъектовМетаданных();

	Для Каждого ОписаниеКоллекции Из КоллекцииОбъектов Цикл

		Для Каждого МетаданныеОбъекта Из ОписаниеКоллекции.Коллекция Цикл

			ПолноеИмяОбъекта = МетаданныеОбъекта.ПолноеИмя();
			ПредставлениеОбъекта = МетаданныеОбъекта.Представление();

			// Получение описания прав для объекта
			ОписаниеПрав = ПолучитьОписаниеПравОбъекта(ПолноеИмяОбъекта);
			Если ОписаниеПрав = Неопределено Тогда
				Продолжить;
			КонецЕсли;

			// Проверка прав роли на объект
			ПроверитьИДобавитьПраваРолиНаОбъект(Результат, МетаданныеРоли, ИмяРоли,
				МетаданныеОбъекта, ПолноеИмяОбъекта, ОписаниеПрав, МассивФильтра);

		КонецЦикла;

	КонецЦикла;

КонецПроцедуры

#КонецОбласти

#Область ПроверкаИДобавлениеПрав

// Проверяет права роли на объект и добавляет результаты в таблицу.
//
// Параметры:
//   ...
//   ФильтрПрофиль - СправочникСсылка.ПрофилиГруппДоступа, Неопределено - фильтр по профилю
//
Процедура ПроверитьИДобавитьПраваРоли(Результат, СтрокаРоли, МетаданныеОбъекта,
	ПолноеИмяОбъекта, ПредставлениеОбъекта, ОписаниеПрав, ПоказыватьПрофили, ПрофилиРолей,
	МассивФильтра, ФильтрПрофиль = Неопределено)

	СписокПрав = ОписаниеПрав.СписокПрав;

	// Перебор прав и проверка наличия
	Для Каждого ЭлементПрава Из СписокПрав Цикл

		ИмяПрава = ЭлементПрава.Значение;
		ПредставлениеПрава = ЭлементПрава.Представление;

		// Применение фильтра по типу доступа
		Если МассивФильтра <> Неопределено
			И МассивФильтра.Найти(ВРег(ИмяПрава)) = Неопределено Тогда
			Продолжить;
		КонецЕсли;

		// Проверка права
		Если ПравоДоступа(ИмяПрава, МетаданныеОбъекта, СтрокаРоли.Метаданные) Тогда

			// Проверка ограничения RLS
			ЕстьОграничение = ПроверитьОграничениеRLS(ИмяПрава, МетаданныеОбъекта, СтрокаРоли.Метаданные);

			Если ПоказыватьПрофили И ПрофилиРолей <> Неопределено Тогда
				// Добавление записей по профилям
				СписокПрофилей = ПрофилиРолей.Получить(СтрокаРоли.ИмяРоли);
				Если СписокПрофилей <> Неопределено Тогда
					Для Каждого ОписаниеПрофиля Из СписокПрофилей Цикл
						// Фильтрация по профилю если задано
						Если ЗначениеЗаполнено(ФильтрПрофиль) И ОписаниеПрофиля.Ссылка <> ФильтрПрофиль Тогда
							Продолжить;
						КонецЕсли;
						НоваяСтрока = Результат.Добавить();
						НоваяСтрока.ОбъектМетаданных = ПолноеИмяОбъекта;
						НоваяСтрока.ИмяРоли = СтрокаРоли.ИмяРоли;
						НоваяСтрока.Профиль = ОписаниеПрофиля.Ссылка;
						НоваяСтрока.ТипДоступа = ПредставлениеПрава;
						НоваяСтрока.ЕстьОграничение = ЕстьОграничение;
					КонецЦикла;
				Иначе
					// Роль без профиля - добавляем только если не фильтруем по профилю
					Если Не ЗначениеЗаполнено(ФильтрПрофиль) Тогда
						НоваяСтрока = Результат.Добавить();
						НоваяСтрока.ОбъектМетаданных = ПолноеИмяОбъекта;
						НоваяСтрока.ИмяРоли = СтрокаРоли.ИмяРоли;
						НоваяСтрока.ТипДоступа = ПредставлениеПрава;
						НоваяСтрока.ЕстьОграничение = ЕстьОграничение;
					КонецЕсли;
				КонецЕсли;
			Иначе
				// Добавление записи по роли - только если не фильтруем по профилю
				Если Не ЗначениеЗаполнено(ФильтрПрофиль) Тогда
					НоваяСтрока = Результат.Добавить();
					НоваяСтрока.ОбъектМетаданных = ПолноеИмяОбъекта;
					НоваяСтрока.ИмяРоли = СтрокаРоли.ИмяРоли;
					НоваяСтрока.ТипДоступа = ПредставлениеПрава;
					НоваяСтрока.ЕстьОграничение = ЕстьОграничение;
				КонецЕсли;
			КонецЕсли;

		КонецЕсли;

	КонецЦикла;

КонецПроцедуры

// Проверяет права профиля на объект и добавляет результаты.
//
Процедура ПроверитьИДобавитьПраваПрофиляНаОбъект(Результат, РолиПрофиля,
	МетаданныеОбъекта, ПолноеИмяОбъекта, ПредставлениеОбъекта,
	ОписаниеПрав, Профиль, ПредставлениеПрофиля, МассивФильтра)

	СписокПрав = ОписаниеПрав.СписокПрав;

	// Перебор прав и проверка наличия хотя бы у одной роли профиля
	Для Каждого ЭлементПрава Из СписокПрав Цикл

		ИмяПрава = ЭлементПрава.Значение;
		ПредставлениеПрава = ЭлементПрава.Представление;

		// Применение фильтра по типу доступа
		Если МассивФильтра <> Неопределено
			И МассивФильтра.Найти(ВРег(ИмяПрава)) = Неопределено Тогда
			Продолжить;
		КонецЕсли;

		ЕстьПраво = Ложь;
		ЕстьОграничение = Ложь;

		// Проверка права у каждой роли профиля
		Для Каждого ОписаниеРоли Из РолиПрофиля Цикл

			Если ПравоДоступа(ИмяПрава, МетаданныеОбъекта, ОписаниеРоли.МетаданныеРоли) Тогда
				ЕстьПраво = Истина;

				// Если хотя бы одна роль имеет право без ограничения - считаем что ограничения нет
				Если Не ПроверитьОграничениеRLS(ИмяПрава, МетаданныеОбъекта, ОписаниеРоли.МетаданныеРоли) Тогда
					ЕстьОграничение = Ложь;
					Прервать;
				Иначе
					ЕстьОграничение = Истина;
				КонецЕсли;
			КонецЕсли;

		КонецЦикла;

		Если ЕстьПраво Тогда
			НоваяСтрока = Результат.Добавить();
			НоваяСтрока.ОбъектМетаданных = ПолноеИмяОбъекта;
			НоваяСтрока.Профиль = Профиль;
			НоваяСтрока.ТипДоступа = ПредставлениеПрава;
			НоваяСтрока.ЕстьОграничение = ЕстьОграничение;
		КонецЕсли;

	КонецЦикла;

КонецПроцедуры

// Проверяет права роли на объект и добавляет результаты (режим анализа по роли).
//
Процедура ПроверитьИДобавитьПраваРолиНаОбъект(Результат, МетаданныеРоли, ИмяРоли,
	МетаданныеОбъекта, ПолноеИмяОбъекта, ОписаниеПрав, МассивФильтра)

	СписокПрав = ОписаниеПрав.СписокПрав;

	// Перебор прав и проверка наличия
	Для Каждого ЭлементПрава Из СписокПрав Цикл

		ИмяПрава = ЭлементПрава.Значение;
		ПредставлениеПрава = ЭлементПрава.Представление;

		// Применение фильтра по типу доступа
		Если МассивФильтра <> Неопределено
			И МассивФильтра.Найти(ВРег(ИмяПрава)) = Неопределено Тогда
			Продолжить;
		КонецЕсли;

		// Проверка права
		Если ПравоДоступа(ИмяПрава, МетаданныеОбъекта, МетаданныеРоли) Тогда

			// Проверка ограничения RLS
			ЕстьОграничение = ПроверитьОграничениеRLS(ИмяПрава, МетаданныеОбъекта, МетаданныеРоли);

			НоваяСтрока = Результат.Добавить();
			НоваяСтрока.ОбъектМетаданных = ПолноеИмяОбъекта;
			НоваяСтрока.ИмяРоли = ИмяРоли;
			НоваяСтрока.ТипДоступа = ПредставлениеПрава;
			НоваяСтрока.ЕстьОграничение = ЕстьОграничение;

		КонецЕсли;

	КонецЦикла;

КонецПроцедуры

#КонецОбласти

#Область РаботаСРолями

// Возвращает таблицу описания всех ролей конфигурации.
//
// Возвращаемое значение:
//   ТаблицаЗначений - описание ролей:
//       * Метаданные - ОбъектМетаданных - метаданные роли
//       * ИмяРоли - Строка - имя роли
//       * ПредставлениеРоли - Строка - представление роли
//
Функция ПолучитьОписаниеРолей()

	ОписаниеРолей = Новый ТаблицаЗначений;
	ОписаниеРолей.Колонки.Добавить("Метаданные");
	ОписаниеРолей.Колонки.Добавить("ИмяРоли", ТипСтрока(255));
	ОписаниеРолей.Колонки.Добавить("ПредставлениеРоли", ТипСтрока(255));

	Для Каждого Роль Из Метаданные.Роли Цикл
		НоваяСтрока = ОписаниеРолей.Добавить();
		НоваяСтрока.Метаданные = Роль;
		НоваяСтрока.ИмяРоли = Роль.Имя;
		НоваяСтрока.ПредставлениеРоли = Роль.Представление();
	КонецЦикла;

	Возврат ОписаниеРолей;

КонецФункции

// Возвращает соответствие ролей и профилей, содержащих эти роли.
//
// Возвращаемое значение:
//   Соответствие - ключ: имя роли, значение: массив структур профилей
//
Функция ПолучитьПрофилиРолей()

	ПрофилиРолей = Новый Соответствие;

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	РолиПрофилей.Роль.Имя КАК ИмяРоли,
	|	РолиПрофилей.Ссылка КАК Профиль,
	|	РолиПрофилей.Ссылка.Наименование КАК НаименованиеПрофиля
	|ИЗ
	|	Справочник.ПрофилиГруппДоступа.Роли КАК РолиПрофилей
	|ГДЕ
	|	НЕ РолиПрофилей.Ссылка.ПометкаУдаления";

	Попытка
		Выборка = Запрос.Выполнить().Выбрать();
	Исключение
		// Справочник ПрофилиГруппДоступа может отсутствовать
		Возврат ПрофилиРолей;
	КонецПопытки;

	Пока Выборка.Следующий() Цикл

		СписокПрофилей = ПрофилиРолей.Получить(Выборка.ИмяРоли);
		Если СписокПрофилей = Неопределено Тогда
			СписокПрофилей = Новый Массив;
			ПрофилиРолей.Вставить(Выборка.ИмяРоли, СписокПрофилей);
		КонецЕсли;

		ОписаниеПрофиля = Новый Структура("Ссылка, Наименование",
			Выборка.Профиль, Выборка.НаименованиеПрофиля);
		СписокПрофилей.Добавить(ОписаниеПрофиля);

	КонецЦикла;

	Возврат ПрофилиРолей;

КонецФункции

// Возвращает роли указанного профиля.
//
// Параметры:
//   Профиль - СправочникСсылка.ПрофилиГруппДоступа - профиль
//
// Возвращаемое значение:
//   Массив - массив структур с описанием ролей профиля
//
Функция ПолучитьРолиПрофиля(Профиль)

	РолиПрофиля = Новый Массив;

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Профиль", Профиль);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	РолиПрофилей.Роль.Имя КАК ИмяРоли
	|ИЗ
	|	Справочник.ПрофилиГруппДоступа.Роли КАК РолиПрофилей
	|ГДЕ
	|	РолиПрофилей.Ссылка = &Профиль";

	Попытка
		Выборка = Запрос.Выполнить().Выбрать();
	Исключение
		Возврат РолиПрофиля;
	КонецПопытки;

	Пока Выборка.Следующий() Цикл

		МетаданныеРоли = Метаданные.Роли.Найти(Выборка.ИмяРоли);
		Если МетаданныеРоли <> Неопределено Тогда
			ОписаниеРоли = Новый Структура("ИмяРоли, МетаданныеРоли",
				Выборка.ИмяРоли, МетаданныеРоли);
			РолиПрофиля.Добавить(ОписаниеРоли);
		КонецЕсли;

	КонецЦикла;

	Возврат РолиПрофиля;

КонецФункции

#КонецОбласти

#Область РаботаСМетаданными

// Возвращает объект метаданных по полному имени.
//
// Параметры:
//   ПолноеИмяОбъекта - Строка - полное имя объекта метаданных
//
// Возвращаемое значение:
//   ОбъектМетаданных, Неопределено - объект метаданных или Неопределено
//
Функция ПолучитьОбъектМетаданных(ПолноеИмяОбъекта)

	Если ПолноеИмяОбъекта = "Конфигурация" Тогда
		Возврат Метаданные;
	КонецЕсли;

	Попытка
		Возврат Метаданные.НайтиПоПолномуИмени(ПолноеИмяОбъекта);
	Исключение
		Возврат Неопределено;
	КонецПопытки;

КонецФункции

// Возвращает представление объекта метаданных.
//
Функция ПолучитьПредставлениеОбъектаМетаданных(МетаданныеОбъекта, ПолноеИмяОбъекта)

	Если ПолноеИмяОбъекта = "Конфигурация" Тогда
		Возврат НСтр("ru = 'Конфигурация'");
	КонецЕсли;

	Попытка
		Возврат МетаданныеОбъекта.Представление();
	Исключение
		Возврат ПолноеИмяОбъекта;
	КонецПопытки;

КонецФункции

// Возвращает коллекции объектов метаданных, для которых можно анализировать права.
//
// Возвращаемое значение:
//   Массив - массив структур с описанием коллекций
//
Функция ПолучитьКоллекцииОбъектовМетаданных()

	Коллекции = Новый Массив;

	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Справочники", Метаданные.Справочники));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Документы", Метаданные.Документы));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "РегистрыСведений", Метаданные.РегистрыСведений));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "РегистрыНакопления", Метаданные.РегистрыНакопления));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "РегистрыБухгалтерии", Метаданные.РегистрыБухгалтерии));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "РегистрыРасчета", Метаданные.РегистрыРасчета));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Константы", Метаданные.Константы));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "ПланыОбмена", Метаданные.ПланыОбмена));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "ПланыВидовХарактеристик", Метаданные.ПланыВидовХарактеристик));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "ПланыСчетов", Метаданные.ПланыСчетов));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "ПланыВидовРасчета", Метаданные.ПланыВидовРасчета));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Отчеты", Метаданные.Отчеты));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Обработки", Метаданные.Обработки));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "БизнесПроцессы", Метаданные.БизнесПроцессы));
	Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Задачи", Метаданные.Задачи));

	Возврат Коллекции;

КонецФункции

#КонецОбласти

#Область ОписаниеПрав

// Возвращает описание прав для объекта метаданных.
//
// Параметры:
//   ПолноеИмяОбъекта - Строка - полное имя объекта метаданных
//
// Возвращаемое значение:
//   Структура, Неопределено - описание прав объекта или Неопределено
//
Функция ПолучитьОписаниеПравОбъекта(ПолноеИмяОбъекта)

	ТипОбъекта = "";
	ЧастиИмени = СтрРазделить(ПолноеИмяОбъекта, ".");
	Если ЧастиИмени.Количество() > 0 Тогда
		ТипОбъекта = ЧастиИмени[0];
	КонецЕсли;

	Если ПолноеИмяОбъекта = "Конфигурация" Тогда
		Возврат ОписаниеПравКонфигурации();

	ИначеЕсли ТипОбъекта = "Справочник" Тогда
		Возврат ОписаниеПравСправочника();

	ИначеЕсли ТипОбъекта = "Документ" Тогда
		Возврат ОписаниеПравДокумента();

	ИначеЕсли ТипОбъекта = "РегистрСведений" Тогда
		Возврат ОписаниеПравРегистраСведений();

	ИначеЕсли ТипОбъекта = "РегистрНакопления"
		Или ТипОбъекта = "РегистрБухгалтерии" Тогда
		Возврат ОписаниеПравРегистраНакопления();

	ИначеЕсли ТипОбъекта = "РегистрРасчета" Тогда
		Возврат ОписаниеПравРегистраРасчета();

	ИначеЕсли ТипОбъекта = "Константа" Тогда
		Возврат ОписаниеПравКонстанты();

	ИначеЕсли ТипОбъекта = "ПланОбмена"
		Или ТипОбъекта = "ПланВидовХарактеристик"
		Или ТипОбъекта = "ПланСчетов"
		Или ТипОбъекта = "ПланВидовРасчета" Тогда
		Возврат ОписаниеПравСправочника();

	ИначеЕсли ТипОбъекта = "Отчет" Или ТипОбъекта = "Обработка" Тогда
		Возврат ОписаниеПравОтчета();

	ИначеЕсли ТипОбъекта = "БизнесПроцесс" Тогда
		Возврат ОписаниеПравБизнесПроцесса();

	ИначеЕсли ТипОбъекта = "Задача" Тогда
		Возврат ОписаниеПравЗадачи();

	КонецЕсли;

	Возврат Неопределено;

КонецФункции

// Создаёт базовую структуру описания прав.
//
Функция СоздатьОписаниеПрав()

	ОписаниеПрав = Новый Структура;
	ОписаниеПрав.Вставить("СписокПрав", Новый СписокЗначений);

	Возврат ОписаниеПрав;

КонецФункции

// Права конфигурации.
Функция ОписаниеПравКонфигурации()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Администрирование", НСтр("ru = 'Администрирование'"));
	СписокПрав.Добавить("АдминистрированиеДанных", НСтр("ru = 'Администрирование данных'"));
	СписокПрав.Добавить("ТонкийКлиент", НСтр("ru = 'Тонкий клиент'"));
	СписокПрав.Добавить("ВебКлиент", НСтр("ru = 'Веб-клиент'"));
	СписокПрав.Добавить("ТолстыйКлиент", НСтр("ru = 'Толстый клиент'"));
	СписокПрав.Добавить("ВнешнееСоединение", НСтр("ru = 'Внешнее соединение'"));
	СписокПрав.Добавить("Вывод", НСтр("ru = 'Вывод'"));
	СписокПрав.Добавить("ИнтерактивноеОткрытиеВнешнихОбработок", НСтр("ru = 'Интерактивное открытие внешних обработок'"));
	СписокПрав.Добавить("ИнтерактивноеОткрытиеВнешнихОтчетов", НСтр("ru = 'Интерактивное открытие внешних отчётов'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права справочника и аналогичных объектов.
Функция ОписаниеПравСправочника()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Добавление", НСтр("ru = 'Добавление'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Удаление", НСтр("ru = 'Удаление'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("ИнтерактивноеДобавление", НСтр("ru = 'Интерактивное добавление'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));
	СписокПрав.Добавить("ИнтерактивноеУдаление", НСтр("ru = 'Интерактивное удаление'"));
	СписокПрав.Добавить("ИнтерактивнаяПометкаУдаления", НСтр("ru = 'Интерактивная пометка удаления'"));
	СписокПрав.Добавить("ИнтерактивноеСнятиеПометкиУдаления", НСтр("ru = 'Интерактивное снятие пометки удаления'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права документа.
Функция ОписаниеПравДокумента()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Добавление", НСтр("ru = 'Добавление'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Удаление", НСтр("ru = 'Удаление'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("ИнтерактивноеДобавление", НСтр("ru = 'Интерактивное добавление'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));
	СписокПрав.Добавить("ИнтерактивноеУдаление", НСтр("ru = 'Интерактивное удаление'"));
	СписокПрав.Добавить("ИнтерактивнаяПометкаУдаления", НСтр("ru = 'Интерактивная пометка удаления'"));
	СписокПрав.Добавить("ИнтерактивноеСнятиеПометкиУдаления", НСтр("ru = 'Интерактивное снятие пометки удаления'"));
	СписокПрав.Добавить("Проведение", НСтр("ru = 'Проведение'"));
	СписокПрав.Добавить("ОтменаПроведения", НСтр("ru = 'Отмена проведения'"));
	СписокПрав.Добавить("ИнтерактивноеПроведение", НСтр("ru = 'Интерактивное проведение'"));
	СписокПрав.Добавить("ИнтерактивнаяОтменаПроведения", НСтр("ru = 'Интерактивная отмена проведения'"));
	СписокПрав.Добавить("ИнтерактивноеИзменениеПроведенных", НСтр("ru = 'Интерактивное изменение проведённых'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права регистра сведений.
Функция ОписаниеПравРегистраСведений()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права регистра накопления и бухгалтерии.
Функция ОписаниеПравРегистраНакопления()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));
	СписокПрав.Добавить("УправлениеИтогами", НСтр("ru = 'Управление итогами'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права регистра расчета.
Функция ОписаниеПравРегистраРасчета()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права константы.
Функция ОписаниеПравКонстанты()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права отчёта и обработки.
Функция ОписаниеПравОтчета()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Использование", НСтр("ru = 'Использование'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права бизнес-процесса.
Функция ОписаниеПравБизнесПроцесса()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Добавление", НСтр("ru = 'Добавление'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Удаление", НСтр("ru = 'Удаление'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("ИнтерактивноеДобавление", НСтр("ru = 'Интерактивное добавление'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));
	СписокПрав.Добавить("Старт", НСтр("ru = 'Старт'"));
	СписокПрав.Добавить("ИнтерактивныйСтарт", НСтр("ru = 'Интерактивный старт'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права задачи.
Функция ОписаниеПравЗадачи()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Добавление", НСтр("ru = 'Добавление'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Удаление", НСтр("ru = 'Удаление'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("ИнтерактивноеДобавление", НСтр("ru = 'Интерактивное добавление'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));
	СписокПрав.Добавить("ИнтерактивнаяАктивация", НСтр("ru = 'Интерактивная активация'"));
	СписокПрав.Добавить("Выполнение", НСтр("ru = 'Выполнение'"));
	СписокПрав.Добавить("ИнтерактивноеВыполнение", НСтр("ru = 'Интерактивное выполнение'"));

	Возврат ОписаниеПрав;

КонецФункции

#КонецОбласти

#Область ПроверкаОграниченийRLS

// Проверяет наличие RLS-ограничения для права на объект.
//
// Параметры:
//   ИмяПрава - Строка - имя права
//   МетаданныеОбъекта - ОбъектМетаданных - объект метаданных
//   МетаданныеРоли - ОбъектМетаданных - метаданные роли
//
// Возвращаемое значение:
//   Булево - Истина, если есть ограничение RLS
//
Функция ПроверитьОграничениеRLS(ИмяПрава, МетаданныеОбъекта, МетаданныеРоли)

	Попытка
		ПолучитьПараметрыДоступаРоли = ПолучитьПараметрыДоступаРоли(ИмяПрава, МетаданныеОбъекта, МетаданныеРоли);
		Возврат ПолучитьПараметрыДоступаРоли.ОграничениеУсловием;
	Исключение
		Возврат Ложь;
	КонецПопытки;

КонецФункции

// Возвращает параметры доступа к объекту для роли.
//
// Параметры:
//   ИмяПрава - Строка - имя права
//   МетаданныеОбъекта - ОбъектМетаданных - объект метаданных
//   МетаданныеРоли - ОбъектМетаданных - метаданные роли
//
// Возвращаемое значение:
//   Структура:
//       * ОграничениеУсловием - Булево - наличие ограничения условием
//
Функция ПолучитьПараметрыДоступаРоли(ИмяПрава, МетаданныеОбъекта, МетаданныеРоли)

	Результат = Новый Структура("ОграничениеУсловием", Ложь);

	Попытка
		// Проверка наличия ограничения доступа к данным (RLS)
		ПраваОбъекта = МетаданныеРоли.ПолучитьПраваОбъекта(МетаданныеОбъекта);

		Для Каждого ПравоОбъекта Из ПраваОбъекта Цикл
			Если ПравоОбъекта.Имя = ИмяПрава Тогда
				// Проверяем наличие ограничения
				Ограничения = ПравоОбъекта.ОграничениеДоступаКДанным;
				Если Ограничения <> Неопределено И Ограничения.Количество() > 0 Тогда
					Для Каждого Ограничение Из Ограничения Цикл
						Если ЗначениеЗаполнено(Ограничение.Условие) Тогда
							Результат.ОграничениеУсловием = Истина;
							Прервать;
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	Исключение
		// Ошибка получения прав - возвращаем значение по умолчанию (без ограничений)
		Результат.ОграничениеУсловием = Ложь;
	КонецПопытки;

	Возврат Результат;

КонецФункции

#КонецОбласти

#Область Вспомогательные

// Подготавливает массив фильтра по типу доступа.
//
// Параметры:
//   ФильтрТипДоступа - Строка, Массив, Неопределено - фильтр
//
// Возвращаемое значение:
//   Массив, Неопределено - массив имён прав в верхнем регистре или Неопределено
//
Функция ПодготовитьФильтрТипаДоступа(ФильтрТипДоступа)

	Если Не ЗначениеЗаполнено(ФильтрТипДоступа) Тогда
		Возврат Неопределено;
	КонецЕсли;

	Результат = Новый Массив;

	Если ТипЗнч(ФильтрТипДоступа) = Тип("Строка") Тогда
		// Одно значение или список через запятую
		Части = СтрРазделить(ФильтрТипДоступа, ",", Ложь);
		Для Каждого Часть Из Части Цикл
			Результат.Добавить(ВРег(СокрЛП(Часть)));
		КонецЦикла;
	ИначеЕсли ТипЗнч(ФильтрТипДоступа) = Тип("Массив") Тогда
		Для Каждого Элемент Из ФильтрТипДоступа Цикл
			Результат.Добавить(ВРег(СокрЛП(Строка(Элемент))));
		КонецЦикла;
	КонецЕсли;

	Если Результат.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;

	Возврат Результат;

КонецФункции

// Создаёт описание типа Строка с указанной длиной.
//
// Параметры:
//   ДлинаСтроки - Число - длина строки
//
// Возвращаемое значение:
//   ОписаниеТипов - описание типа Строка
//
Функция ТипСтрока(ДлинаСтроки)

	Возврат Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(ДлинаСтроки));

КонецФункции

#КонецОбласти


#КонецОбласти

#КонецЕсли
