///////////////////////////////////////////////////////////////////////////////////////////////////////
// Внешняя обработка "Экспорт анализа прав доступа в Markdown"
// Анализирует права доступа ролей и профилей к объектам метаданных конфигурации
// и выгружает результаты в формате Markdown
///////////////////////////////////////////////////////////////////////////////////////////////////////

#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Возвращает сведения о внешней обработке для регистрации в системе БСП.
//
// Возвращаемое значение:
//   Структура - параметры регистрации внешней обработки
//
Функция СведенияОВнешнейОбработке() Экспорт
	
	ПараметрыРегистрации = ДополнительныеОтчетыИОбработки.СведенияОВнешнейОбработке(СтандартныеПодсистемыСервер.ВерсияБиблиотеки());	
	
	ПараметрыРегистрации.Вид = ДополнительныеОтчетыИОбработкиКлиентСервер.ВидОбработкиДополнительнаяОбработка();
    ПараметрыРегистрации.Версия = "1.0";
	ПараметрыРегистрации.Наименование = "Продвинутый анализ прав доступа";
	ПараметрыРегистрации.БезопасныйРежим = Ложь;
	ПараметрыРегистрации.Информация = 
		НСтр("ru = 'Обработка анализирует права доступа ролей и профилей к объектам метаданных
		|и выгружает результаты в формат Markdown (.md).
		|Позволяет узнать, какие роли/профили имеют доступ к указанному объекту,
		|или какие объекты доступны указанной роли/профилю.'");
	
	НоваяКоманда = ПараметрыРегистрации.Команды.Добавить();
	НоваяКоманда.Представление = НСтр("ru = 'Экспорт анализа прав доступа'");
	НоваяКоманда.Идентификатор = "ЭкспортАнализаПравДоступа";
	НоваяКоманда.Использование = "ОткрытиеФормы";
	НоваяКоманда.ПоказыватьОповещение = Ложь;

	Возврат ПараметрыРегистрации;

КонецФункции

// Возвращает итоговую таблицу с результатами анализа прав доступа.
//
// Параметры:
//   Параметры - Структура - параметры анализа:
//       * ОбъектМетаданных - Строка - полное имя объекта метаданных или Неопределено
//       * ИмяРоли - Строка - имя роли или Неопределено
//       * Профиль - СправочникСсылка.ПрофилиГруппДоступа - профиль или Неопределено
//       * ТипДоступа - Строка, Массив - фильтр по типу доступа или Неопределено
//       * ПоказыватьПрофили - Булево - показывать профили вместо ролей (по умолчанию Истина)
//
// Возвращаемое значение:
//   ТаблицаЗначений - результаты анализа:
//       * ОбъектМетаданных - Строка - полное имя объекта (при фильтре по роли/профилю)
//       * ИмяРоли - Строка - имя роли (при фильтре по объекту)
//       * Профиль - СправочникСсылка.ПрофилиГруппДоступа - профиль
//       * ТипДоступа - Строка - тип права доступа
//       * ЕстьОграничение - Булево - наличие RLS-ограничения
//
Функция ПолучитьИтоговуюТаблицу(Параметры) Экспорт

	// Инициализация параметров
	ОбъектМетаданных = Неопределено;
	ИмяРоли = Неопределено;
	Профиль = Неопределено;
	ФильтрТипДоступа = Неопределено;
	ПоказыватьПрофили = Истина;
	ФильтрОбъектов = Неопределено;

	Если Параметры.Свойство("ОбъектМетаданных") Тогда
		ОбъектМетаданных = Параметры.ОбъектМетаданных;
	КонецЕсли;

	Если Параметры.Свойство("ИмяРоли") Тогда
		ИмяРоли = Параметры.ИмяРоли;
	КонецЕсли;

	Если Параметры.Свойство("Профиль") Тогда
		Профиль = Параметры.Профиль;
	КонецЕсли;

	Если Параметры.Свойство("ТипДоступа") Тогда
		ФильтрТипДоступа = Параметры.ТипДоступа;
	КонецЕсли;

	Если Параметры.Свойство("ПоказыватьПрофили") Тогда
		ПоказыватьПрофили = Параметры.ПоказыватьПрофили;
	КонецЕсли;

	Если Параметры.Свойство("ФильтрОбъектов") Тогда
		ФильтрОбъектов = Параметры.ФильтрОбъектов;
	КонецЕсли;

	// Валидация комбинации фильтров
	Если ЗначениеЗаполнено(Профиль) И ЗначениеЗаполнено(ИмяРоли) Тогда
		// Проверить, что роль входит в профиль
		РолиПрофиляДляПроверки = ПолучитьРолиПрофиля(Профиль);
		РольНайдена = Ложь;
		Для Каждого ОписаниеРоли Из РолиПрофиляДляПроверки Цикл
			Если ОписаниеРоли.ИмяРоли = ИмяРоли Тогда
				РольНайдена = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		Если Не РольНайдена Тогда
			ВызватьИсключение "Роль """ + ИмяРоли + """ не входит в профиль """ + Строка(Профиль) + """";
		КонецЕсли;
	КонецЕсли;

	Если ЗначениеЗаполнено(ОбъектМетаданных) И ФильтрОбъектов <> Неопределено Тогда
		// Проверить, что тип объекта входит в фильтр
		ПроверитьСоответствиеОбъектаФильтру(ОбъектМетаданных, ФильтрОбъектов);
	КонецЕсли;

	// Создание результирующей таблицы
	РезультатАнализа = СоздатьТаблицуРезультатов();

	// Определение режима работы с учётом комбинации фильтров
	Если ЗначениеЗаполнено(ОбъектМетаданных) Тогда
		// Режим: анализ по объекту метаданных (с возможной фильтрацией по Профилю/Роли)
		АнализПоОбъектуМетаданных(РезультатАнализа, ОбъектМетаданных, ПоказыватьПрофили,
			ФильтрТипДоступа, Профиль, ИмяРоли);

	ИначеЕсли ЗначениеЗаполнено(Профиль) Тогда
		// Режим: анализ по профилю (с возможной фильтрацией по Роли)
		АнализПоПрофилю(РезультатАнализа, Профиль, ФильтрТипДоступа, ФильтрОбъектов, ИмяРоли);

	ИначеЕсли ЗначениеЗаполнено(ИмяРоли) Тогда
		// Режим: анализ по роли
		АнализПоРоли(РезультатАнализа, ИмяРоли, ФильтрТипДоступа, ФильтрОбъектов);

	КонецЕсли;

	Возврат СгруппироватьТипыДоступа(РезультатАнализа);

КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область СозданиеТаблиц

// Создаёт пустую таблицу результатов анализа.
//
// Возвращаемое значение:
//   ТаблицаЗначений - пустая таблица с колонками результатов
//
Функция СоздатьТаблицуРезультатов()

	Результат = Новый ТаблицаЗначений;

	Результат.Колонки.Добавить("ОбъектМетаданных", ТипСтрока(430));
	Результат.Колонки.Добавить("ИмяРоли", ТипСтрока(255));
	Результат.Колонки.Добавить("Профиль", Новый ОписаниеТипов("СправочникСсылка.ПрофилиГруппДоступа"));
	Результат.Колонки.Добавить("ТипДоступа", ТипСтрока(100));
	Результат.Колонки.Добавить("ЕстьОграничение", Новый ОписаниеТипов("Булево"));

	Возврат Результат;

КонецФункции

// Группирует строки таблицы результатов, объединяя типы доступа через запятую.
// Группировка выполняется по комбинации (ОбъектМетаданных, ИмяРоли, Профиль, ЕстьОграничение).
//
// Параметры:
//   ИсходнаяТаблица - ТаблицаЗначений - исходная таблица с отдельными строками для каждого типа доступа
//
// Возвращаемое значение:
//   ТаблицаЗначений - сгруппированная таблица с объединёнными типами доступа
//
Функция СгруппироватьТипыДоступа(ИсходнаяТаблица)

	Результат = СоздатьТаблицуРезультатов();

	// Создаём соответствие для группировки
	Группы = Новый Соответствие;

	Для Каждого СтрокаТаблицы Из ИсходнаяТаблица Цикл
		// Ключ группировки
		Ключ = СтрокаТаблицы.ОбъектМетаданных + "|"
			 + СтрокаТаблицы.ИмяРоли + "|"
			 + Строка(СтрокаТаблицы.Профиль) + "|"
			 + Строка(СтрокаТаблицы.ЕстьОграничение);

		Группа = Группы.Получить(Ключ);
		Если Группа = Неопределено Тогда
			Группа = Новый Структура;
			Группа.Вставить("ОбъектМетаданных", СтрокаТаблицы.ОбъектМетаданных);
			Группа.Вставить("ИмяРоли", СтрокаТаблицы.ИмяРоли);
			Группа.Вставить("Профиль", СтрокаТаблицы.Профиль);
			Группа.Вставить("ЕстьОграничение", СтрокаТаблицы.ЕстьОграничение);
			Группа.Вставить("ТипыДоступа", Новый Массив);
			Группы.Вставить(Ключ, Группа);
		КонецЕсли;

		Группа.ТипыДоступа.Добавить(СтрокаТаблицы.ТипДоступа);
	КонецЦикла;

	// Формируем результат
	Для Каждого КлючЗначение Из Группы Цикл
		Группа = КлючЗначение.Значение;
		НоваяСтрока = Результат.Добавить();
		НоваяСтрока.ОбъектМетаданных = Группа.ОбъектМетаданных;
		НоваяСтрока.ИмяРоли = Группа.ИмяРоли;
		НоваяСтрока.Профиль = Группа.Профиль;
		НоваяСтрока.ТипДоступа = СтрСоединить(Группа.ТипыДоступа, ",");
		НоваяСтрока.ЕстьОграничение = Группа.ЕстьОграничение;
	КонецЦикла;

	Возврат Результат;

КонецФункции

#КонецОбласти

#Область ОсновныеПроцедурыАнализа

// Выполняет анализ прав по указанному объекту метаданных.
// Определяет, какие роли и профили имеют доступ к объекту.
//
// Параметры:
//   Результат - ТаблицаЗначений - таблица для заполнения результатами
//   ПолноеИмяОбъекта - Строка - полное имя объекта метаданных
//   ПоказыватьПрофили - Булево - показывать профили вместо ролей
//   ФильтрТипДоступа - Строка, Массив, Неопределено - фильтр по типу доступа
//   ФильтрПрофиль - СправочникСсылка.ПрофилиГруппДоступа, Неопределено - фильтр по профилю
//   ФильтрИмяРоли - Строка, Неопределено - фильтр по имени роли
//
Процедура АнализПоОбъектуМетаданных(Результат, ПолноеИмяОбъекта, ПоказыватьПрофили,
	ФильтрТипДоступа, ФильтрПрофиль = Неопределено, ФильтрИмяРоли = Неопределено)

	// Получение объекта метаданных
	МетаданныеОбъекта = ПолучитьОбъектМетаданных(ПолноеИмяОбъекта);
	Если МетаданныеОбъекта = Неопределено Тогда
		Возврат;
	КонецЕсли;

	ПредставлениеОбъекта = ПолучитьПредставлениеОбъектаМетаданных(МетаданныеОбъекта, ПолноеИмяОбъекта);

	// Получение описания прав для данного типа объекта
	ОписаниеПрав = ПолучитьОписаниеПравОбъекта(ПолноеИмяОбъекта);
	Если ОписаниеПрав = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Получение описания ролей
	ОписаниеРолей = ПолучитьОписаниеРолей();

	// Получение профилей, если требуется
	ПрофилиРолей = Неопределено;
	Если ПоказыватьПрофили Тогда
		ПрофилиРолей = ПолучитьПрофилиРолей();
	КонецЕсли;

	// Обработка фильтра по типу доступа
	МассивФильтра = ПодготовитьФильтрТипаДоступа(ФильтрТипДоступа);

	// Перебор ролей и проверка прав
	Для Каждого СтрокаРоли Из ОписаниеРолей Цикл

		// Фильтрация по имени роли
		Если ЗначениеЗаполнено(ФильтрИмяРоли) И СтрокаРоли.ИмяРоли <> ФильтрИмяРоли Тогда
			Продолжить;
		КонецЕсли;

		// Проверка прав роли на объект
		ПроверитьИДобавитьПраваРоли(Результат, СтрокаРоли, МетаданныеОбъекта,
			ПолноеИмяОбъекта, ПредставлениеОбъекта, ОписаниеПрав,
			ПоказыватьПрофили, ПрофилиРолей, МассивФильтра, ФильтрПрофиль);

	КонецЦикла;

КонецПроцедуры

// Выполняет анализ прав по указанному профилю.
// Определяет, к каким объектам метаданных есть доступ у профиля.
//
// Параметры:
//   Результат - ТаблицаЗначений - таблица для заполнения результатами
//   Профиль - СправочникСсылка.ПрофилиГруппДоступа - профиль
//   ФильтрТипДоступа - Строка, Массив, Неопределено - фильтр по типу доступа
//   ФильтрОбъектов - Структура, Неопределено - фильтр по типам объектов метаданных
//   ФильтрИмяРоли - Строка, Неопределено - фильтр по имени роли (роль должна входить в профиль)
//
Процедура АнализПоПрофилю(Результат, Профиль, ФильтрТипДоступа, ФильтрОбъектов = Неопределено,
	ФильтрИмяРоли = Неопределено)

	// Получение ролей профиля
	РолиПрофиля = ПолучитьРолиПрофиля(Профиль);
	Если РолиПрофиля.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	// Фильтрация по роли если задано
	Если ЗначениеЗаполнено(ФильтрИмяРоли) Тогда
		ОтфильтрованныеРоли = Новый Массив;
		Для Каждого ОписаниеРоли Из РолиПрофиля Цикл
			Если ОписаниеРоли.ИмяРоли = ФильтрИмяРоли Тогда
				ОтфильтрованныеРоли.Добавить(ОписаниеРоли);
				Прервать;
			КонецЕсли;
		КонецЦикла;
		РолиПрофиля = ОтфильтрованныеРоли;
	КонецЕсли;

	ПредставлениеПрофиля = Строка(Профиль);

	// Обработка фильтра по типу доступа
	МассивФильтра = ПодготовитьФильтрТипаДоступа(ФильтрТипДоступа);

	// Перебор объектов метаданных с правами
	КоллекцииОбъектов = ПолучитьКоллекцииОбъектовМетаданных(ФильтрОбъектов);

	Для Каждого ОписаниеКоллекции Из КоллекцииОбъектов Цикл

		Для Каждого МетаданныеОбъекта Из ОписаниеКоллекции.Коллекция Цикл

			ПолноеИмяОбъекта = МетаданныеОбъекта.ПолноеИмя();
			ПредставлениеОбъекта = МетаданныеОбъекта.Представление();

			// Получение описания прав для объекта
			ОписаниеПрав = ПолучитьОписаниеПравОбъекта(ПолноеИмяОбъекта);
			Если ОписаниеПрав = Неопределено Тогда
				Продолжить;
			КонецЕсли;

			// Проверка прав профиля (объединение прав всех ролей)
			ПроверитьИДобавитьПраваПрофиляНаОбъект(Результат, РолиПрофиля,
				МетаданныеОбъекта, ПолноеИмяОбъекта, ПредставлениеОбъекта,
				ОписаниеПрав, Профиль, ПредставлениеПрофиля, МассивФильтра);

		КонецЦикла;

	КонецЦикла;

КонецПроцедуры

// Выполняет анализ прав по указанной роли.
// Определяет, к каким объектам метаданных есть доступ у роли.
//
// Параметры:
//   Результат - ТаблицаЗначений - таблица для заполнения результатами
//   ИмяРоли - Строка - имя роли
//   ФильтрТипДоступа - Строка, Массив, Неопределено - фильтр по типу доступа
//   ФильтрОбъектов - Структура, Неопределено - фильтр по типам объектов метаданных
//
Процедура АнализПоРоли(Результат, ИмяРоли, ФильтрТипДоступа, ФильтрОбъектов = Неопределено)

	// Проверка существования роли
	МетаданныеРоли = Метаданные.Роли.Найти(ИмяРоли);
	Если МетаданныеРоли = Неопределено Тогда
		Возврат;
	КонецЕсли;

	ПредставлениеРоли = МетаданныеРоли.Представление();

	// Обработка фильтра по типу доступа
	МассивФильтра = ПодготовитьФильтрТипаДоступа(ФильтрТипДоступа);

	// Перебор объектов метаданных с правами
	КоллекцииОбъектов = ПолучитьКоллекцииОбъектовМетаданных(ФильтрОбъектов);

	Для Каждого ОписаниеКоллекции Из КоллекцииОбъектов Цикл

		Для Каждого МетаданныеОбъекта Из ОписаниеКоллекции.Коллекция Цикл

			ПолноеИмяОбъекта = МетаданныеОбъекта.ПолноеИмя();
			ПредставлениеОбъекта = МетаданныеОбъекта.Представление();

			// Получение описания прав для объекта
			ОписаниеПрав = ПолучитьОписаниеПравОбъекта(ПолноеИмяОбъекта);
			Если ОписаниеПрав = Неопределено Тогда
				Продолжить;
			КонецЕсли;

			// Проверка прав роли на объект
			ПроверитьИДобавитьПраваРолиНаОбъект(Результат, МетаданныеРоли, ИмяРоли,
				МетаданныеОбъекта, ПолноеИмяОбъекта, ОписаниеПрав, МассивФильтра);

		КонецЦикла;

	КонецЦикла;

КонецПроцедуры

#КонецОбласти

#Область ПроверкаИДобавлениеПрав

// Проверяет права роли на объект и добавляет результаты в таблицу.
//
// Параметры:
//   ...
//   ФильтрПрофиль - СправочникСсылка.ПрофилиГруппДоступа, Неопределено - фильтр по профилю
//
Процедура ПроверитьИДобавитьПраваРоли(Результат, СтрокаРоли, МетаданныеОбъекта,
	ПолноеИмяОбъекта, ПредставлениеОбъекта, ОписаниеПрав, ПоказыватьПрофили, ПрофилиРолей,
	МассивФильтра, ФильтрПрофиль = Неопределено)

	СписокПрав = ОписаниеПрав.СписокПрав;

	// Перебор прав и проверка наличия
	Для Каждого ЭлементПрава Из СписокПрав Цикл

		ИмяПрава = ЭлементПрава.Значение;
		ПредставлениеПрава = ЭлементПрава.Представление;

		// Применение фильтра по типу доступа
		Если МассивФильтра <> Неопределено
			И МассивФильтра.Найти(ВРег(ИмяПрава)) = Неопределено Тогда
			Продолжить;
		КонецЕсли;

		// Проверка права
		Если ПравоДоступа(ИмяПрава, МетаданныеОбъекта, СтрокаРоли.Метаданные) Тогда

			// Проверка ограничения RLS
			ЕстьОграничение = ПроверитьОграничениеRLS(ИмяПрава, МетаданныеОбъекта, СтрокаРоли.Метаданные);

			Если ПоказыватьПрофили И ПрофилиРолей <> Неопределено Тогда
				// Добавление записей по профилям
				СписокПрофилей = ПрофилиРолей.Получить(СтрокаРоли.ИмяРоли);
				Если СписокПрофилей <> Неопределено Тогда
					Для Каждого ОписаниеПрофиля Из СписокПрофилей Цикл
						// Фильтрация по профилю если задано
						Если ЗначениеЗаполнено(ФильтрПрофиль) И ОписаниеПрофиля.Ссылка <> ФильтрПрофиль Тогда
							Продолжить;
						КонецЕсли;
						НоваяСтрока = Результат.Добавить();
						НоваяСтрока.ОбъектМетаданных = ПолноеИмяОбъекта;
						НоваяСтрока.ИмяРоли = СтрокаРоли.ИмяРоли;
						НоваяСтрока.Профиль = ОписаниеПрофиля.Ссылка;
						НоваяСтрока.ТипДоступа = ПредставлениеПрава;
						НоваяСтрока.ЕстьОграничение = ЕстьОграничение;
					КонецЦикла;
				Иначе
					// Роль без профиля - добавляем только если не фильтруем по профилю
					Если Не ЗначениеЗаполнено(ФильтрПрофиль) Тогда
						НоваяСтрока = Результат.Добавить();
						НоваяСтрока.ОбъектМетаданных = ПолноеИмяОбъекта;
						НоваяСтрока.ИмяРоли = СтрокаРоли.ИмяРоли;
						НоваяСтрока.ТипДоступа = ПредставлениеПрава;
						НоваяСтрока.ЕстьОграничение = ЕстьОграничение;
					КонецЕсли;
				КонецЕсли;
			Иначе
				// Добавление записи по роли - только если не фильтруем по профилю
				Если Не ЗначениеЗаполнено(ФильтрПрофиль) Тогда
					НоваяСтрока = Результат.Добавить();
					НоваяСтрока.ОбъектМетаданных = ПолноеИмяОбъекта;
					НоваяСтрока.ИмяРоли = СтрокаРоли.ИмяРоли;
					НоваяСтрока.ТипДоступа = ПредставлениеПрава;
					НоваяСтрока.ЕстьОграничение = ЕстьОграничение;
				КонецЕсли;
			КонецЕсли;

		КонецЕсли;

	КонецЦикла;

КонецПроцедуры

// Проверяет права профиля на объект и добавляет результаты.
//
Процедура ПроверитьИДобавитьПраваПрофиляНаОбъект(Результат, РолиПрофиля,
	МетаданныеОбъекта, ПолноеИмяОбъекта, ПредставлениеОбъекта,
	ОписаниеПрав, Профиль, ПредставлениеПрофиля, МассивФильтра)

	СписокПрав = ОписаниеПрав.СписокПрав;

	// Перебор прав и проверка наличия хотя бы у одной роли профиля
	Для Каждого ЭлементПрава Из СписокПрав Цикл

		ИмяПрава = ЭлементПрава.Значение;
		ПредставлениеПрава = ЭлементПрава.Представление;

		// Применение фильтра по типу доступа
		Если МассивФильтра <> Неопределено
			И МассивФильтра.Найти(ВРег(ИмяПрава)) = Неопределено Тогда
			Продолжить;
		КонецЕсли;

		ЕстьПраво = Ложь;
		ЕстьОграничение = Ложь;

		// Проверка права у каждой роли профиля
		Для Каждого ОписаниеРоли Из РолиПрофиля Цикл

			Если ПравоДоступа(ИмяПрава, МетаданныеОбъекта, ОписаниеРоли.МетаданныеРоли) Тогда
				ЕстьПраво = Истина;

				// Если хотя бы одна роль имеет право без ограничения - считаем что ограничения нет
				Если Не ПроверитьОграничениеRLS(ИмяПрава, МетаданныеОбъекта, ОписаниеРоли.МетаданныеРоли) Тогда
					ЕстьОграничение = Ложь;
					Прервать;
				Иначе
					ЕстьОграничение = Истина;
				КонецЕсли;
			КонецЕсли;

		КонецЦикла;

		Если ЕстьПраво Тогда
			НоваяСтрока = Результат.Добавить();
			НоваяСтрока.ОбъектМетаданных = ПолноеИмяОбъекта;
			НоваяСтрока.Профиль = Профиль;
			НоваяСтрока.ТипДоступа = ПредставлениеПрава;
			НоваяСтрока.ЕстьОграничение = ЕстьОграничение;
		КонецЕсли;

	КонецЦикла;

КонецПроцедуры

// Проверяет права роли на объект и добавляет результаты (режим анализа по роли).
//
Процедура ПроверитьИДобавитьПраваРолиНаОбъект(Результат, МетаданныеРоли, ИмяРоли,
	МетаданныеОбъекта, ПолноеИмяОбъекта, ОписаниеПрав, МассивФильтра)

	СписокПрав = ОписаниеПрав.СписокПрав;

	// Перебор прав и проверка наличия
	Для Каждого ЭлементПрава Из СписокПрав Цикл

		ИмяПрава = ЭлементПрава.Значение;
		ПредставлениеПрава = ЭлементПрава.Представление;

		// Применение фильтра по типу доступа
		Если МассивФильтра <> Неопределено
			И МассивФильтра.Найти(ВРег(ИмяПрава)) = Неопределено Тогда
			Продолжить;
		КонецЕсли;

		// Проверка права
		Если ПравоДоступа(ИмяПрава, МетаданныеОбъекта, МетаданныеРоли) Тогда

			// Проверка ограничения RLS
			ЕстьОграничение = ПроверитьОграничениеRLS(ИмяПрава, МетаданныеОбъекта, МетаданныеРоли);

			НоваяСтрока = Результат.Добавить();
			НоваяСтрока.ОбъектМетаданных = ПолноеИмяОбъекта;
			НоваяСтрока.ИмяРоли = ИмяРоли;
			НоваяСтрока.ТипДоступа = ПредставлениеПрава;
			НоваяСтрока.ЕстьОграничение = ЕстьОграничение;

		КонецЕсли;

	КонецЦикла;

КонецПроцедуры

#КонецОбласти

#Область РаботаСРолями

// Возвращает таблицу описания всех ролей конфигурации.
//
// Возвращаемое значение:
//   ТаблицаЗначений - описание ролей:
//       * Метаданные - ОбъектМетаданных - метаданные роли
//       * ИмяРоли - Строка - имя роли
//       * ПредставлениеРоли - Строка - представление роли
//
Функция ПолучитьОписаниеРолей()

	ОписаниеРолей = Новый ТаблицаЗначений;
	ОписаниеРолей.Колонки.Добавить("Метаданные");
	ОписаниеРолей.Колонки.Добавить("ИмяРоли", ТипСтрока(255));
	ОписаниеРолей.Колонки.Добавить("ПредставлениеРоли", ТипСтрока(255));

	Для Каждого Роль Из Метаданные.Роли Цикл
		НоваяСтрока = ОписаниеРолей.Добавить();
		НоваяСтрока.Метаданные = Роль;
		НоваяСтрока.ИмяРоли = Роль.Имя;
		НоваяСтрока.ПредставлениеРоли = Роль.Представление();
	КонецЦикла;

	Возврат ОписаниеРолей;

КонецФункции

// Возвращает соответствие ролей и профилей, содержащих эти роли.
//
// Возвращаемое значение:
//   Соответствие - ключ: имя роли, значение: массив структур профилей
//
Функция ПолучитьПрофилиРолей()

	ПрофилиРолей = Новый Соответствие;

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	РолиПрофилей.Роль.Имя КАК ИмяРоли,
	|	РолиПрофилей.Ссылка КАК Профиль,
	|	РолиПрофилей.Ссылка.Наименование КАК НаименованиеПрофиля
	|ИЗ
	|	Справочник.ПрофилиГруппДоступа.Роли КАК РолиПрофилей
	|ГДЕ
	|	НЕ РолиПрофилей.Ссылка.ПометкаУдаления";

	Попытка
		Выборка = Запрос.Выполнить().Выбрать();
	Исключение
		// Справочник ПрофилиГруппДоступа может отсутствовать
		Возврат ПрофилиРолей;
	КонецПопытки;

	Пока Выборка.Следующий() Цикл

		СписокПрофилей = ПрофилиРолей.Получить(Выборка.ИмяРоли);
		Если СписокПрофилей = Неопределено Тогда
			СписокПрофилей = Новый Массив;
			ПрофилиРолей.Вставить(Выборка.ИмяРоли, СписокПрофилей);
		КонецЕсли;

		ОписаниеПрофиля = Новый Структура("Ссылка, Наименование",
			Выборка.Профиль, Выборка.НаименованиеПрофиля);
		СписокПрофилей.Добавить(ОписаниеПрофиля);

	КонецЦикла;

	Возврат ПрофилиРолей;

КонецФункции

// Возвращает роли указанного профиля.
//
// Параметры:
//   Профиль - СправочникСсылка.ПрофилиГруппДоступа - профиль
//
// Возвращаемое значение:
//   Массив - массив структур с описанием ролей профиля
//
Функция ПолучитьРолиПрофиля(Профиль)

	РолиПрофиля = Новый Массив;

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Профиль", Профиль);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	РолиПрофилей.Роль.Имя КАК ИмяРоли
	|ИЗ
	|	Справочник.ПрофилиГруппДоступа.Роли КАК РолиПрофилей
	|ГДЕ
	|	РолиПрофилей.Ссылка = &Профиль";

	Попытка
		Выборка = Запрос.Выполнить().Выбрать();
	Исключение
		Возврат РолиПрофиля;
	КонецПопытки;

	Пока Выборка.Следующий() Цикл

		МетаданныеРоли = Метаданные.Роли.Найти(Выборка.ИмяРоли);
		Если МетаданныеРоли <> Неопределено Тогда
			ОписаниеРоли = Новый Структура("ИмяРоли, МетаданныеРоли",
				Выборка.ИмяРоли, МетаданныеРоли);
			РолиПрофиля.Добавить(ОписаниеРоли);
		КонецЕсли;

	КонецЦикла;

	Возврат РолиПрофиля;

КонецФункции

#КонецОбласти

#Область РаботаСМетаданными

// Возвращает объект метаданных по полному имени.
//
// Параметры:
//   ПолноеИмяОбъекта - Строка - полное имя объекта метаданных
//
// Возвращаемое значение:
//   ОбъектМетаданных, Неопределено - объект метаданных или Неопределено
//
Функция ПолучитьОбъектМетаданных(ПолноеИмяОбъекта)

	Если ПолноеИмяОбъекта = "Конфигурация" Тогда
		Возврат Метаданные;
	КонецЕсли;

	Попытка
		Возврат Метаданные.НайтиПоПолномуИмени(ПолноеИмяОбъекта);
	Исключение
		Возврат Неопределено;
	КонецПопытки;

КонецФункции

// Возвращает представление объекта метаданных.
//
Функция ПолучитьПредставлениеОбъектаМетаданных(МетаданныеОбъекта, ПолноеИмяОбъекта)

	Если ПолноеИмяОбъекта = "Конфигурация" Тогда
		Возврат НСтр("ru = 'Конфигурация'");
	КонецЕсли;

	Попытка
		Возврат МетаданныеОбъекта.Представление();
	Исключение
		Возврат ПолноеИмяОбъекта;
	КонецПопытки;

КонецФункции

// Возвращает коллекции объектов метаданных, для которых можно анализировать права.
//
// Параметры:
//   ФильтрОбъектов - Структура, Неопределено - параметры фильтрации объектов:
//       * ВключатьСправочники - Булево - включать справочники
//       * ВключатьДокументы - Булево - включать документы
//       * ВключатьРегистрыСведений - Булево - включать регистры сведений
//       * ВключатьРегистрыНакопления - Булево - включать регистры накопления
//       * ВключатьРегистрыБухгалтерии - Булево - включать регистры бухгалтерии
//       * ВключатьОтчеты - Булево - включать отчёты
//       * ВключатьОбработки - Булево - включать обработки
//       * ВключатьКонстанты - Булево - включать константы
//   Если параметр не передан или свойство отсутствует - объект включается
//
// Возвращаемое значение:
//   Массив - массив структур с описанием коллекций
//
Функция ПолучитьКоллекцииОбъектовМетаданных(ФильтрОбъектов = Неопределено)

	Коллекции = Новый Массив;

	// Справочники
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьСправочники") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Справочники", Метаданные.Справочники));
	КонецЕсли;

	// Документы
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьДокументы") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Документы", Метаданные.Документы));
	КонецЕсли;

	// Регистры сведений
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьРегистрыСведений") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "РегистрыСведений", Метаданные.РегистрыСведений));
	КонецЕсли;

	// Регистры накопления
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьРегистрыНакопления") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "РегистрыНакопления", Метаданные.РегистрыНакопления));
	КонецЕсли;

	// Регистры бухгалтерии
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьРегистрыБухгалтерии") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "РегистрыБухгалтерии", Метаданные.РегистрыБухгалтерии));
	КонецЕсли;

	// Регистры расчета
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьРегистрыРасчета") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "РегистрыРасчета", Метаданные.РегистрыРасчета));
	КонецЕсли;

	// Константы
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьКонстанты") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Константы", Метаданные.Константы));
	КонецЕсли;

	// Планы обмена
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьПланыОбмена") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "ПланыОбмена", Метаданные.ПланыОбмена));
	КонецЕсли;

	// Планы видов характеристик
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьПланыВидовХарактеристик") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "ПланыВидовХарактеристик", Метаданные.ПланыВидовХарактеристик));
	КонецЕсли;

	// Планы счетов
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьПланыСчетов") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "ПланыСчетов", Метаданные.ПланыСчетов));
	КонецЕсли;

	// Планы видов расчета
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьПланыВидовРасчета") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "ПланыВидовРасчета", Метаданные.ПланыВидовРасчета));
	КонецЕсли;

	// Отчёты
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьОтчеты") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Отчеты", Метаданные.Отчеты));
	КонецЕсли;

	// Обработки
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьОбработки") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Обработки", Метаданные.Обработки));
	КонецЕсли;

	// Бизнес-процессы
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьБизнесПроцессы") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "БизнесПроцессы", Метаданные.БизнесПроцессы));
	КонецЕсли;

	// Задачи
	Если ПроверитьВключениеКоллекции(ФильтрОбъектов, "ВключатьЗадачи") Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Задачи", Метаданные.Задачи));
	КонецЕсли;

	Возврат Коллекции;

КонецФункции

// Проверяет, что тип объекта метаданных входит в фильтр объектов.
// Если не входит - выбрасывает исключение с понятным сообщением.
//
// Параметры:
//   ПолноеИмяОбъекта - Строка - полное имя объекта метаданных (например, "Справочник.Номенклатура")
//   ФильтрОбъектов - Структура - параметры фильтрации по типам объектов
//
Процедура ПроверитьСоответствиеОбъектаФильтру(ПолноеИмяОбъекта, ФильтрОбъектов)

	// Определяем тип коллекции по полному имени объекта
	ПозицияТочки = СтрНайти(ПолноеИмяОбъекта, ".");
	Если ПозицияТочки = 0 Тогда
		Возврат; // Не можем определить тип - пропускаем проверку
	КонецЕсли;

	ТипОбъекта = Лев(ПолноеИмяОбъекта, ПозицияТочки - 1);

	// Соответствие типа объекта и имени параметра фильтра
	СоответствиеТипов = Новый Соответствие;
	СоответствиеТипов.Вставить("Справочник", "ВключатьСправочники");
	СоответствиеТипов.Вставить("Документ", "ВключатьДокументы");
	СоответствиеТипов.Вставить("РегистрСведений", "ВключатьРегистрыСведений");
	СоответствиеТипов.Вставить("РегистрНакопления", "ВключатьРегистрыНакопления");
	СоответствиеТипов.Вставить("РегистрБухгалтерии", "ВключатьРегистрыБухгалтерии");
	СоответствиеТипов.Вставить("РегистрРасчета", "ВключатьРегистрыРасчета");
	СоответствиеТипов.Вставить("Константа", "ВключатьКонстанты");
	СоответствиеТипов.Вставить("ПланОбмена", "ВключатьПланыОбмена");
	СоответствиеТипов.Вставить("ПланВидовХарактеристик", "ВключатьПланыВидовХарактеристик");
	СоответствиеТипов.Вставить("ПланСчетов", "ВключатьПланыСчетов");
	СоответствиеТипов.Вставить("ПланВидовРасчета", "ВключатьПланыВидовРасчета");
	СоответствиеТипов.Вставить("Отчет", "ВключатьОтчеты");
	СоответствиеТипов.Вставить("Обработка", "ВключатьОбработки");
	СоответствиеТипов.Вставить("БизнесПроцесс", "ВключатьБизнесПроцессы");
	СоответствиеТипов.Вставить("Задача", "ВключатьЗадачи");

	ИмяПараметра = СоответствиеТипов.Получить(ТипОбъекта);
	Если ИмяПараметра = Неопределено Тогда
		Возврат; // Неизвестный тип - пропускаем проверку
	КонецЕсли;

	// Проверяем значение параметра фильтра
	Если Не ПроверитьВключениеКоллекции(ФильтрОбъектов, ИмяПараметра) Тогда
		// Формируем понятное сообщение об ошибке
		СоответствиеПредставлений = Новый Соответствие;
		СоответствиеПредставлений.Вставить("Справочник", "Справочники");
		СоответствиеПредставлений.Вставить("Документ", "Документы");
		СоответствиеПредставлений.Вставить("РегистрСведений", "Регистры сведений");
		СоответствиеПредставлений.Вставить("РегистрНакопления", "Регистры накопления");
		СоответствиеПредставлений.Вставить("РегистрБухгалтерии", "Регистры бухгалтерии");
		СоответствиеПредставлений.Вставить("РегистрРасчета", "Регистры расчёта");
		СоответствиеПредставлений.Вставить("Константа", "Константы");
		СоответствиеПредставлений.Вставить("ПланОбмена", "Планы обмена");
		СоответствиеПредставлений.Вставить("ПланВидовХарактеристик", "Планы видов характеристик");
		СоответствиеПредставлений.Вставить("ПланСчетов", "Планы счетов");
		СоответствиеПредставлений.Вставить("ПланВидовРасчета", "Планы видов расчёта");
		СоответствиеПредставлений.Вставить("Отчет", "Отчёты");
		СоответствиеПредставлений.Вставить("Обработка", "Обработки");
		СоответствиеПредставлений.Вставить("БизнесПроцесс", "Бизнес-процессы");
		СоответствиеПредставлений.Вставить("Задача", "Задачи");

		ПредставлениеТипа = СоответствиеПредставлений.Получить(ТипОбъекта);
		ВызватьИсключение "Объект """ + ПолноеИмяОбъекта + """ относится к типу """ + ПредставлениеТипа
			+ """, но этот тип отключён в фильтре. Включите """ + ПредставлениеТипа + """ в настройках фильтра.";
	КонецЕсли;

КонецПроцедуры

// Проверяет, нужно ли включать коллекцию объектов в анализ.
//
// Параметры:
//   ФильтрОбъектов - Структура, Неопределено - параметры фильтрации
//   ИмяПараметра - Строка - имя параметра фильтрации
//
// Возвращаемое значение:
//   Булево - Истина, если коллекцию нужно включить
//
Функция ПроверитьВключениеКоллекции(ФильтрОбъектов, ИмяПараметра)

	Если ФильтрОбъектов = Неопределено Тогда
		Возврат Истина;
	КонецЕсли;

	Значение = Неопределено;
	Если ФильтрОбъектов.Свойство(ИмяПараметра, Значение) Тогда
		Возврат Значение = Истина;
	КонецЕсли;

	Возврат Истина;

КонецФункции

#КонецОбласти

#Область ОписаниеПрав

// Возвращает описание прав для объекта метаданных.
//
// Параметры:
//   ПолноеИмяОбъекта - Строка - полное имя объекта метаданных
//
// Возвращаемое значение:
//   Структура, Неопределено - описание прав объекта или Неопределено
//
Функция ПолучитьОписаниеПравОбъекта(ПолноеИмяОбъекта)

	ТипОбъекта = "";
	ЧастиИмени = СтрРазделить(ПолноеИмяОбъекта, ".");
	Если ЧастиИмени.Количество() > 0 Тогда
		ТипОбъекта = ЧастиИмени[0];
	КонецЕсли;

	Если ПолноеИмяОбъекта = "Конфигурация" Тогда
		Возврат ОписаниеПравКонфигурации();

	ИначеЕсли ТипОбъекта = "Справочник" Тогда
		Возврат ОписаниеПравСправочника();

	ИначеЕсли ТипОбъекта = "Документ" Тогда
		Возврат ОписаниеПравДокумента();

	ИначеЕсли ТипОбъекта = "РегистрСведений" Тогда
		Возврат ОписаниеПравРегистраСведений();

	ИначеЕсли ТипОбъекта = "РегистрНакопления"
		Или ТипОбъекта = "РегистрБухгалтерии" Тогда
		Возврат ОписаниеПравРегистраНакопления();

	ИначеЕсли ТипОбъекта = "РегистрРасчета" Тогда
		Возврат ОписаниеПравРегистраРасчета();

	ИначеЕсли ТипОбъекта = "Константа" Тогда
		Возврат ОписаниеПравКонстанты();

	ИначеЕсли ТипОбъекта = "ПланОбмена"
		Или ТипОбъекта = "ПланВидовХарактеристик"
		Или ТипОбъекта = "ПланСчетов"
		Или ТипОбъекта = "ПланВидовРасчета" Тогда
		Возврат ОписаниеПравСправочника();

	ИначеЕсли ТипОбъекта = "Отчет" Или ТипОбъекта = "Обработка" Тогда
		Возврат ОписаниеПравОтчета();

	ИначеЕсли ТипОбъекта = "БизнесПроцесс" Тогда
		Возврат ОписаниеПравБизнесПроцесса();

	ИначеЕсли ТипОбъекта = "Задача" Тогда
		Возврат ОписаниеПравЗадачи();

	КонецЕсли;

	Возврат Неопределено;

КонецФункции

// Создаёт базовую структуру описания прав.
//
Функция СоздатьОписаниеПрав()

	ОписаниеПрав = Новый Структура;
	ОписаниеПрав.Вставить("СписокПрав", Новый СписокЗначений);

	Возврат ОписаниеПрав;

КонецФункции

// Права конфигурации.
Функция ОписаниеПравКонфигурации()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Администрирование", НСтр("ru = 'Администрирование'"));
	СписокПрав.Добавить("АдминистрированиеДанных", НСтр("ru = 'Администрирование данных'"));
	СписокПрав.Добавить("ТонкийКлиент", НСтр("ru = 'Тонкий клиент'"));
	СписокПрав.Добавить("ВебКлиент", НСтр("ru = 'Веб-клиент'"));
	СписокПрав.Добавить("ТолстыйКлиент", НСтр("ru = 'Толстый клиент'"));
	СписокПрав.Добавить("ВнешнееСоединение", НСтр("ru = 'Внешнее соединение'"));
	СписокПрав.Добавить("Вывод", НСтр("ru = 'Вывод'"));
	СписокПрав.Добавить("ИнтерактивноеОткрытиеВнешнихОбработок", НСтр("ru = 'Интерактивное открытие внешних обработок'"));
	СписокПрав.Добавить("ИнтерактивноеОткрытиеВнешнихОтчетов", НСтр("ru = 'Интерактивное открытие внешних отчётов'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права справочника и аналогичных объектов.
Функция ОписаниеПравСправочника()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Добавление", НСтр("ru = 'Добавление'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Удаление", НСтр("ru = 'Удаление'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("ИнтерактивноеДобавление", НСтр("ru = 'Интерактивное добавление'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));
	СписокПрав.Добавить("ИнтерактивноеУдаление", НСтр("ru = 'Интерактивное удаление'"));
	СписокПрав.Добавить("ИнтерактивнаяПометкаУдаления", НСтр("ru = 'Интерактивная пометка удаления'"));
	СписокПрав.Добавить("ИнтерактивноеСнятиеПометкиУдаления", НСтр("ru = 'Интерактивное снятие пометки удаления'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права документа.
Функция ОписаниеПравДокумента()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Добавление", НСтр("ru = 'Добавление'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Удаление", НСтр("ru = 'Удаление'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("ИнтерактивноеДобавление", НСтр("ru = 'Интерактивное добавление'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));
	СписокПрав.Добавить("ИнтерактивноеУдаление", НСтр("ru = 'Интерактивное удаление'"));
	СписокПрав.Добавить("ИнтерактивнаяПометкаУдаления", НСтр("ru = 'Интерактивная пометка удаления'"));
	СписокПрав.Добавить("ИнтерактивноеСнятиеПометкиУдаления", НСтр("ru = 'Интерактивное снятие пометки удаления'"));
	СписокПрав.Добавить("Проведение", НСтр("ru = 'Проведение'"));
	СписокПрав.Добавить("ОтменаПроведения", НСтр("ru = 'Отмена проведения'"));
	СписокПрав.Добавить("ИнтерактивноеПроведение", НСтр("ru = 'Интерактивное проведение'"));
	СписокПрав.Добавить("ИнтерактивнаяОтменаПроведения", НСтр("ru = 'Интерактивная отмена проведения'"));
	СписокПрав.Добавить("ИнтерактивноеИзменениеПроведенных", НСтр("ru = 'Интерактивное изменение проведённых'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права регистра сведений.
Функция ОписаниеПравРегистраСведений()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права регистра накопления и бухгалтерии.
Функция ОписаниеПравРегистраНакопления()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));
	СписокПрав.Добавить("УправлениеИтогами", НСтр("ru = 'Управление итогами'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права регистра расчета.
Функция ОписаниеПравРегистраРасчета()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права константы.
Функция ОписаниеПравКонстанты()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права отчёта и обработки.
Функция ОписаниеПравОтчета()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Использование", НСтр("ru = 'Использование'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права бизнес-процесса.
Функция ОписаниеПравБизнесПроцесса()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Добавление", НСтр("ru = 'Добавление'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Удаление", НСтр("ru = 'Удаление'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("ИнтерактивноеДобавление", НСтр("ru = 'Интерактивное добавление'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));
	СписокПрав.Добавить("Старт", НСтр("ru = 'Старт'"));
	СписокПрав.Добавить("ИнтерактивныйСтарт", НСтр("ru = 'Интерактивный старт'"));

	Возврат ОписаниеПрав;

КонецФункции

// Права задачи.
Функция ОписаниеПравЗадачи()

	ОписаниеПрав = СоздатьОписаниеПрав();
	СписокПрав = ОписаниеПрав.СписокПрав;

	СписокПрав.Добавить("Чтение", НСтр("ru = 'Чтение'"));
	СписокПрав.Добавить("Добавление", НСтр("ru = 'Добавление'"));
	СписокПрав.Добавить("Изменение", НСтр("ru = 'Изменение'"));
	СписокПрав.Добавить("Удаление", НСтр("ru = 'Удаление'"));
	СписокПрав.Добавить("Просмотр", НСтр("ru = 'Просмотр'"));
	СписокПрав.Добавить("ИнтерактивноеДобавление", НСтр("ru = 'Интерактивное добавление'"));
	СписокПрав.Добавить("Редактирование", НСтр("ru = 'Редактирование'"));
	СписокПрав.Добавить("ИнтерактивнаяАктивация", НСтр("ru = 'Интерактивная активация'"));
	СписокПрав.Добавить("Выполнение", НСтр("ru = 'Выполнение'"));
	СписокПрав.Добавить("ИнтерактивноеВыполнение", НСтр("ru = 'Интерактивное выполнение'"));

	Возврат ОписаниеПрав;

КонецФункции

#КонецОбласти

#Область ПроверкаОграниченийRLS

// Проверяет наличие RLS-ограничения для права на объект.
//
// Параметры:
//   ИмяПрава - Строка - имя права
//   МетаданныеОбъекта - ОбъектМетаданных - объект метаданных
//   МетаданныеРоли - ОбъектМетаданных - метаданные роли
//
// Возвращаемое значение:
//   Булево - Истина, если есть ограничение RLS
//
Функция ПроверитьОграничениеRLS(ИмяПрава, МетаданныеОбъекта, МетаданныеРоли)

	Попытка
		ПолучитьПараметрыДоступаРоли = ПолучитьПараметрыДоступаРоли(ИмяПрава, МетаданныеОбъекта, МетаданныеРоли);
		Возврат ПолучитьПараметрыДоступаРоли.ОграничениеУсловием;
	Исключение
		Возврат Ложь;
	КонецПопытки;

КонецФункции

// Возвращает параметры доступа к объекту для роли.
//
// Параметры:
//   ИмяПрава - Строка - имя права
//   МетаданныеОбъекта - ОбъектМетаданных - объект метаданных
//   МетаданныеРоли - ОбъектМетаданных - метаданные роли
//
// Возвращаемое значение:
//   Структура:
//       * ОграничениеУсловием - Булево - наличие ограничения условием
//
Функция ПолучитьПараметрыДоступаРоли(ИмяПрава, МетаданныеОбъекта, МетаданныеРоли)

	Результат = Новый Структура("ОграничениеУсловием", Ложь);

	Попытка
		// Проверка наличия ограничения доступа к данным (RLS)
		ПраваОбъекта = МетаданныеРоли.ПолучитьПраваОбъекта(МетаданныеОбъекта);

		Для Каждого ПравоОбъекта Из ПраваОбъекта Цикл
			Если ПравоОбъекта.Имя = ИмяПрава Тогда
				// Проверяем наличие ограничения
				Ограничения = ПравоОбъекта.ОграничениеДоступаКДанным;
				Если Ограничения <> Неопределено И Ограничения.Количество() > 0 Тогда
					Для Каждого Ограничение Из Ограничения Цикл
						Если ЗначениеЗаполнено(Ограничение.Условие) Тогда
							Результат.ОграничениеУсловием = Истина;
							Прервать;
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	Исключение
		// Ошибка получения прав - возвращаем значение по умолчанию (без ограничений)
		Результат.ОграничениеУсловием = Ложь;
	КонецПопытки;

	Возврат Результат;

КонецФункции

#КонецОбласти

#Область Вспомогательные

// Подготавливает массив фильтра по типу доступа.
//
// Параметры:
//   ФильтрТипДоступа - Строка, Массив, Неопределено - фильтр
//
// Возвращаемое значение:
//   Массив, Неопределено - массив имён прав в верхнем регистре или Неопределено
//
Функция ПодготовитьФильтрТипаДоступа(ФильтрТипДоступа)

	Если Не ЗначениеЗаполнено(ФильтрТипДоступа) Тогда
		Возврат Неопределено;
	КонецЕсли;

	Результат = Новый Массив;

	Если ТипЗнч(ФильтрТипДоступа) = Тип("Строка") Тогда
		// Одно значение или список через запятую
		Части = СтрРазделить(ФильтрТипДоступа, ",", Ложь);
		Для Каждого Часть Из Части Цикл
			Результат.Добавить(ВРег(СокрЛП(Часть)));
		КонецЦикла;
	ИначеЕсли ТипЗнч(ФильтрТипДоступа) = Тип("Массив") Тогда
		Для Каждого Элемент Из ФильтрТипДоступа Цикл
			Результат.Добавить(ВРег(СокрЛП(Строка(Элемент))));
		КонецЦикла;
	КонецЕсли;

	Если Результат.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;

	Возврат Результат;

КонецФункции

// Создаёт описание типа Строка с указанной длиной.
//
// Параметры:
//   ДлинаСтроки - Число - длина строки
//
// Возвращаемое значение:
//   ОписаниеТипов - описание типа Строка
//
Функция ТипСтрока(ДлинаСтроки)

	Возврат Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(ДлинаСтроки));

КонецФункции

#КонецОбласти

#Область РанжированиеОбъектов

// Ранжирует объекты метаданных по бизнес-значимости на основе алгоритма PageRank.
// Использует матрицу прав доступа (объекты × роли) для вычисления весов объектов.
//
// Параметры:
//   Параметры - Структура - параметры ранжирования:
//       * Epsilon - Число - порог сходимости (по умолчанию 0.0001)
//       * МаксИтераций - Число - максимум итераций (по умолчанию 100)
//       * ПорогОтсечения - Число - минимальный вес для включения (по умолчанию 0)
//       * ВключатьСправочники - Булево - включать справочники (по умолчанию Истина)
//       * ВключатьДокументы - Булево - включать документы (по умолчанию Истина)
//       * ВключатьРегистрыСведений - Булево - включать регистры сведений (по умолчанию Истина)
//       * ВключатьРегистрыНакопления - Булево - включать регистры накопления (по умолчанию Истина)
//       * ВключатьРегистрыБухгалтерии - Булево - включать регистры бухгалтерии (по умолчанию Ложь)
//       * ВключатьОтчеты - Булево - включать отчёты (по умолчанию Ложь)
//       * ВключатьОбработки - Булево - включать обработки (по умолчанию Ложь)
//       * ВключатьКонстанты - Булево - включать константы (по умолчанию Ложь)
//
// Возвращаемое значение:
//   ТаблицаЗначений - результаты ранжирования:
//       * Ранг - Число - позиция в рейтинге (1 = самый значимый)
//       * ОбъектМетаданных - Строка - полное имя объекта
//       * ТипОбъекта - Строка - тип объекта (Справочник, Документ и т.д.)
//       * Вес - Число - числовая оценка значимости [0..1]
//       * КоличествоРолей - Число - в скольких ролях есть право Чтение
//
Функция РанжироватьОбъектыПоЗначимости(Параметры = Неопределено) Экспорт

	// Инициализация параметров по умолчанию
	Epsilon = 0.0001;
	МаксИтераций = 100;
	ПорогОтсечения = 0;

	ФильтрТипов = Новый Структура;
	ФильтрТипов.Вставить("Справочники", Истина);
	ФильтрТипов.Вставить("Документы", Истина);
	ФильтрТипов.Вставить("РегистрыСведений", Истина);
	ФильтрТипов.Вставить("РегистрыНакопления", Истина);
	ФильтрТипов.Вставить("РегистрыБухгалтерии", Ложь);
	ФильтрТипов.Вставить("Отчеты", Ложь);
	ФильтрТипов.Вставить("Обработки", Ложь);
	ФильтрТипов.Вставить("Константы", Ложь);

	Если Параметры <> Неопределено Тогда
		Если Параметры.Свойство("Epsilon") И ЗначениеЗаполнено(Параметры.Epsilon) Тогда
			Epsilon = Параметры.Epsilon;
		КонецЕсли;
		Если Параметры.Свойство("МаксИтераций") И ЗначениеЗаполнено(Параметры.МаксИтераций) Тогда
			МаксИтераций = Параметры.МаксИтераций;
		КонецЕсли;
		Если Параметры.Свойство("ПорогОтсечения") Тогда
			ПорогОтсечения = Параметры.ПорогОтсечения;
		КонецЕсли;
		Если Параметры.Свойство("ВключатьСправочники") Тогда
			ФильтрТипов.Справочники = Параметры.ВключатьСправочники;
		КонецЕсли;
		Если Параметры.Свойство("ВключатьДокументы") Тогда
			ФильтрТипов.Документы = Параметры.ВключатьДокументы;
		КонецЕсли;
		Если Параметры.Свойство("ВключатьРегистрыСведений") Тогда
			ФильтрТипов.РегистрыСведений = Параметры.ВключатьРегистрыСведений;
		КонецЕсли;
		Если Параметры.Свойство("ВключатьРегистрыНакопления") Тогда
			ФильтрТипов.РегистрыНакопления = Параметры.ВключатьРегистрыНакопления;
		КонецЕсли;
		Если Параметры.Свойство("ВключатьРегистрыБухгалтерии") Тогда
			ФильтрТипов.РегистрыБухгалтерии = Параметры.ВключатьРегистрыБухгалтерии;
		КонецЕсли;
		Если Параметры.Свойство("ВключатьОтчеты") Тогда
			ФильтрТипов.Отчеты = Параметры.ВключатьОтчеты;
		КонецЕсли;
		Если Параметры.Свойство("ВключатьОбработки") Тогда
			ФильтрТипов.Обработки = Параметры.ВключатьОбработки;
		КонецЕсли;
		Если Параметры.Свойство("ВключатьКонстанты") Тогда
			ФильтрТипов.Константы = Параметры.ВключатьКонстанты;
		КонецЕсли;
	КонецЕсли;

	// 1. Построение матрицы прав
	ДанныеМатрицы = ПостроитьМатрицуПрав(ФильтрТипов);

	Если ДанныеМатрицы.СписокОбъектов.Количество() = 0 Тогда
		Возврат СоздатьТаблицуРанжирования();
	КонецЕсли;

	// 2. Вычисление весов методом степенных итераций (PageRank)
	ВесаОбъектов = ВычислитьВесаОбъектовPageRank(ДанныеМатрицы, Epsilon, МаксИтераций);

	// 3. Формирование результата
	Результат = СоздатьТаблицуРанжирования();

	Для Индекс = 0 По ДанныеМатрицы.СписокОбъектов.ВГраница() Цикл
		Вес = ВесаОбъектов[Индекс];

		// Отсечение по порогу
		Если Вес < ПорогОтсечения Тогда
			Продолжить;
		КонецЕсли;

		НоваяСтрока = Результат.Добавить();
		НоваяСтрока.ОбъектМетаданных = ДанныеМатрицы.СписокОбъектов[Индекс];
		НоваяСтрока.ТипОбъекта = ДанныеМатрицы.ТипыОбъектов[Индекс];
		НоваяСтрока.Вес = Вес;
		НоваяСтрока.КоличествоРолей = ДанныеМатрицы.КоличествоРолейОбъекта[Индекс];
	КонецЦикла;

	// 4. Сортировка по убыванию веса и присвоение рангов
	Результат.Сортировать("Вес УБЫВ");

	Ранг = 0;
	Для Каждого СтрокаРезультата Из Результат Цикл
		Ранг = Ранг + 1;
		СтрокаРезультата.Ранг = Ранг;
	КонецЦикла;

	Возврат Результат;

КонецФункции

// Создаёт пустую таблицу результатов ранжирования.
//
// Возвращаемое значение:
//   ТаблицаЗначений - пустая таблица с колонками результатов ранжирования
//
Функция СоздатьТаблицуРанжирования()

	Результат = Новый ТаблицаЗначений;

	Результат.Колонки.Добавить("Ранг", Новый ОписаниеТипов("Число"));
	Результат.Колонки.Добавить("ОбъектМетаданных", ТипСтрока(430));
	Результат.Колонки.Добавить("ТипОбъекта", ТипСтрока(100));
	Результат.Колонки.Добавить("Вес", Новый ОписаниеТипов("Число"));
	Результат.Колонки.Добавить("КоличествоРолей", Новый ОписаниеТипов("Число"));

	Возврат Результат;

КонецФункции

// Строит взвешенную матрицу прав доступа (объекты x роли).
// W[i][j] = (кол-во типов прав объекта i в роли j) / (макс. кол-во прав объекта i в любой роли)
// Вес отражает разнообразие предоставленных прав: больше прав = сильнее связь.
//
// Параметры:
//   ФильтрТипов - Структура - фильтр включаемых типов объектов
//
// Возвращаемое значение:
//   Структура:
//       * Матрица - Массив массивов - взвешенная матрица W[объект][роль], значения [0..1]
//       * СписокОбъектов - Массив - имена объектов (индексы строк матрицы)
//       * ТипыОбъектов - Массив - типы объектов
//       * СписокРолей - Массив - имена ролей (индексы столбцов матрицы)
//       * КоличествоРолейОбъекта - Массив - количество ролей с хотя бы одним правом
//
Функция ПостроитьМатрицуПрав(ФильтрТипов)

	Результат = Новый Структура;
	Результат.Вставить("Матрица", Новый Массив);
	Результат.Вставить("СписокОбъектов", Новый Массив);
	Результат.Вставить("ТипыОбъектов", Новый Массив);
	Результат.Вставить("СписокРолей", Новый Массив);
	Результат.Вставить("КоличествоРолейОбъекта", Новый Массив);

	// Получение списка ролей
	Для Каждого Роль Из Метаданные.Роли Цикл
		Результат.СписокРолей.Добавить(Роль);
	КонецЦикла;

	КоличествоРолей = Результат.СписокРолей.Количество();
	Если КоличествоРолей = 0 Тогда
		Возврат Результат;
	КонецЕсли;

	// Получение списка объектов с учётом фильтра типов
	КоллекцииОбъектов = ПолучитьКоллекцииОбъектовДляРанжирования(ФильтрТипов);

	// Построение матрицы с подсчётом количества прав
	Для Каждого ОписаниеКоллекции Из КоллекцииОбъектов Цикл

		// Получение списка прав для проверки для данного типа объекта
		ПроверяемыеПрава = ПолучитьПроверяемыеПраваДляТипаОбъекта(ОписаниеКоллекции.Имя);

		Для Каждого МетаданныеОбъекта Из ОписаниеКоллекции.Коллекция Цикл

			ПолноеИмяОбъекта = МетаданныеОбъекта.ПолноеИмя();

			// Создание строки матрицы для объекта (сырые значения - количество прав)
			СтрокаМатрицы = Новый Массив(КоличествоРолей);
			КоличествоРолейСПравом = 0;
			МаксимумПравВРоли = 0;

			Для ИндексРоли = 0 По КоличествоРолей - 1 Цикл
				МетаданныеРоли = Результат.СписокРолей[ИндексРоли];

				// Подсчёт количества типов прав для данной пары объект-роль
				КоличествоПрав = 0;
				Для Каждого ИмяПрава Из ПроверяемыеПрава Цикл
					Попытка
						Если ПравоДоступа(ИмяПрава, МетаданныеОбъекта, МетаданныеРоли) Тогда
							КоличествоПрав = КоличествоПрав + 1;
						КонецЕсли;
					Исключение
						// Право не применимо к данному объекту - пропускаем
						Продолжить;
					КонецПопытки;
				КонецЦикла;

				СтрокаМатрицы[ИндексРоли] = КоличествоПрав;

				Если КоличествоПрав > 0 Тогда
					КоличествоРолейСПравом = КоличествоРолейСПравом + 1;
				КонецЕсли;

				Если КоличествоПрав > МаксимумПравВРоли Тогда
					МаксимумПравВРоли = КоличествоПрав;
				КонецЕсли;
			КонецЦикла;

			// Нормализация строки матрицы: W[i,j] = raw[i,j] / max_i
			Если МаксимумПравВРоли > 0 Тогда
				Для ИндексРоли = 0 По КоличествоРолей - 1 Цикл
					СтрокаМатрицы[ИндексРоли] = СтрокаМатрицы[ИндексРоли] / МаксимумПравВРоли;
				КонецЦикла;
			КонецЕсли;

			// Добавляем объект только если у него есть хотя бы одна роль с правом
			Если КоличествоРолейСПравом > 0 Тогда
				Результат.Матрица.Добавить(СтрокаМатрицы);
				Результат.СписокОбъектов.Добавить(ПолноеИмяОбъекта);
				Результат.ТипыОбъектов.Добавить(ОписаниеКоллекции.Имя);
				Результат.КоличествоРолейОбъекта.Добавить(КоличествоРолейСПравом);
			КонецЕсли;

		КонецЦикла;

	КонецЦикла;

	Возврат Результат;

КонецФункции

// Возвращает коллекции объектов метаданных для ранжирования с учётом фильтра.
//
// Параметры:
//   ФильтрТипов - Структура - какие типы объектов включать
//
// Возвращаемое значение:
//   Массив - массив структур {Имя, Коллекция}
//
Функция ПолучитьКоллекцииОбъектовДляРанжирования(ФильтрТипов)

	Коллекции = Новый Массив;

	Если ФильтрТипов.Справочники Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Справочник", Метаданные.Справочники));
	КонецЕсли;

	Если ФильтрТипов.Документы Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Документ", Метаданные.Документы));
	КонецЕсли;

	Если ФильтрТипов.РегистрыСведений Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "РегистрСведений", Метаданные.РегистрыСведений));
	КонецЕсли;

	Если ФильтрТипов.РегистрыНакопления Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "РегистрНакопления", Метаданные.РегистрыНакопления));
	КонецЕсли;

	Если ФильтрТипов.РегистрыБухгалтерии Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "РегистрБухгалтерии", Метаданные.РегистрыБухгалтерии));
	КонецЕсли;

	Если ФильтрТипов.Отчеты Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Отчет", Метаданные.Отчеты));
	КонецЕсли;

	Если ФильтрТипов.Обработки Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Обработка", Метаданные.Обработки));
	КонецЕсли;

	Если ФильтрТипов.Константы Тогда
		Коллекции.Добавить(Новый Структура("Имя, Коллекция", "Константа", Метаданные.Константы));
	КонецЕсли;

	Возврат Коллекции;

КонецФункции

// Возвращает массив имён прав для проверки в зависимости от типа объекта метаданных.
// Используется для построения взвешенной матрицы прав.
//
// Параметры:
//   ТипОбъекта - Строка - тип объекта (Справочник, Документ, РегистрСведений и т.д.)
//
// Возвращаемое значение:
//   Массив - массив строк с именами прав для проверки
//
Функция ПолучитьПроверяемыеПраваДляТипаОбъекта(ТипОбъекта)

	Права = Новый Массив;

	Если ТипОбъекта = "Справочник" Тогда
		Права.Добавить("Чтение");
		Права.Добавить("Добавление");
		Права.Добавить("Изменение");
		Права.Добавить("Удаление");

	ИначеЕсли ТипОбъекта = "Документ" Тогда
		Права.Добавить("Чтение");
		Права.Добавить("Добавление");
		Права.Добавить("Изменение");
		Права.Добавить("Удаление");
		Права.Добавить("Проведение");

	ИначеЕсли ТипОбъекта = "РегистрСведений"
		Или ТипОбъекта = "РегистрНакопления"
		Или ТипОбъекта = "РегистрБухгалтерии" Тогда
		Права.Добавить("Чтение");
		Права.Добавить("Изменение");

	ИначеЕсли ТипОбъекта = "Отчет"
		Или ТипОбъекта = "Обработка" Тогда
		Права.Добавить("Использование");
		Права.Добавить("Просмотр");

	ИначеЕсли ТипОбъекта = "Константа" Тогда
		Права.Добавить("Чтение");
		Права.Добавить("Изменение");

	Иначе
		// Для прочих типов проверяем только Чтение
		Права.Добавить("Чтение");

	КонецЕсли;

	Возврат Права;

КонецФункции

// Вычисляет веса объектов методом степенных итераций (PageRank).
// Находит главный собственный вектор матрицы S = M × Mᵀ.
//
// Параметры:
//   ДанныеМатрицы - Структура - данные матрицы прав
//   Epsilon - Число - порог сходимости
//   МаксИтераций - Число - максимальное число итераций
//
// Возвращаемое значение:
//   Массив - веса объектов (нормированные)
//
Функция ВычислитьВесаОбъектовPageRank(ДанныеМатрицы, Epsilon, МаксИтераций)

	КоличествоОбъектов = ДанныеМатрицы.СписокОбъектов.Количество();
	КоличествоРолей = ДанныеМатрицы.СписокРолей.Количество();

	Если КоличествоОбъектов = 0 Тогда
		Возврат Новый Массив;
	КонецЕсли;

	// Инициализация вектора весов равными значениями
	w = Новый Массив(КоличествоОбъектов);
	НачальныйВес = 1 / КоличествоОбъектов;
	Для i = 0 По КоличествоОбъектов - 1 Цикл
		w[i] = НачальныйВес;
	КонецЦикла;

	// Степенные итерации
	Для Итерация = 1 По МаксИтераций Цикл

		// Вычисление w_new = S × w = M × (Mᵀ × w)
		// Шаг 1: u = Mᵀ × w (вектор по ролям)
		u = Новый Массив(КоличествоРолей);
		Для j = 0 По КоличествоРолей - 1 Цикл
			Сумма = 0;
			Для i = 0 По КоличествоОбъектов - 1 Цикл
				Сумма = Сумма + ДанныеМатрицы.Матрица[i][j] * w[i];
			КонецЦикла;
			u[j] = Сумма;
		КонецЦикла;

		// Шаг 2: w_new = M × u (вектор по объектам)
		w_new = Новый Массив(КоличествоОбъектов);
		Для i = 0 По КоличествоОбъектов - 1 Цикл
			Сумма = 0;
			Для j = 0 По КоличествоРолей - 1 Цикл
				Сумма = Сумма + ДанныеМатрицы.Матрица[i][j] * u[j];
			КонецЦикла;
			w_new[i] = Сумма;
		КонецЦикла;

		// Нормировка вектора
		w_new = НормироватьВектор(w_new);

		// Проверка сходимости
		МаксИзменение = ВычислитьМаксИзменение(w, w_new);
		Если МаксИзменение < Epsilon Тогда
			Возврат w_new;
		КонецЕсли;

		w = w_new;

	КонецЦикла;

	Возврат w;

КонецФункции

// Нормирует вектор (делит на евклидову норму).
//
// Параметры:
//   Вектор - Массив - исходный вектор
//
// Возвращаемое значение:
//   Массив - нормированный вектор
//
Функция НормироватьВектор(Вектор)

	// Вычисление евклидовой нормы
	СуммаКвадратов = 0;
	Для Каждого Элемент Из Вектор Цикл
		СуммаКвадратов = СуммаКвадратов + Элемент * Элемент;
	КонецЦикла;

	Норма = Sqrt(СуммаКвадратов);

	Если Норма = 0 Тогда
		Возврат Вектор;
	КонецЕсли;

	// Нормировка
	Результат = Новый Массив(Вектор.Количество());
	Для i = 0 По Вектор.ВГраница() Цикл
		Результат[i] = Вектор[i] / Норма;
	КонецЦикла;

	Возврат Результат;

КонецФункции

// Вычисляет максимальное абсолютное изменение между двумя векторами.
//
// Параметры:
//   Вектор1 - Массив - первый вектор
//   Вектор2 - Массив - второй вектор
//
// Возвращаемое значение:
//   Число - максимальное абсолютное изменение
//
Функция ВычислитьМаксИзменение(Вектор1, Вектор2)

	МаксИзменение = 0;

	Для i = 0 По Вектор1.ВГраница() Цикл
		Разница = Вектор2[i] - Вектор1[i];
		Изменение = ?(Разница < 0, -Разница, Разница);
		Если Изменение > МаксИзменение Тогда
			МаксИзменение = Изменение;
		КонецЕсли;
	КонецЦикла;

	Возврат МаксИзменение;

КонецФункции

#КонецОбласти

#КонецОбласти

#КонецЕсли
